name: Mobile App Release

permissions:
  contents: write # Required for creating releases and pushing version commits
  packages: write # Required for package operations

on:
  # Manual trigger only - no automatic deployments
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch
      use_latest_build:
        description: "Use latest Expo build (skip new build, just create GitHub release)"
        required: false
        default: false
        type: boolean
      skip_build:
        description: "Skip build (for testing workflow only)"
        required: false
        default: false
        type: boolean
      local_build:
        description: "Build on GitHub Actions runner (no EAS credits needed)"
        required: false
        default: false
        type: boolean
      is_qa:
        description: "Mark as QA release (adds -qa suffix to tag)"
        required: false
        default: false
        type: boolean
      is_prerelease:
        description: "Mark as prerelease (draft/beta release)"
        required: false
        default: false
        type: boolean

env:
  MOBILE_DIR: apps/frontend_mobile/iayos_mobile

jobs:
  analyze-and-build:
    name: Analyze Changes & Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.commit_version.outputs.final_version || steps.version.outputs.new_version }}
      tag_name: ${{ steps.commit_version.outputs.tag_name || steps.version.outputs.tag_name }}
      version_type: ${{ steps.analyze.outputs.version_type }}
      should_release: ${{ steps.analyze.outputs.should_release }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MOBILE_RELEASE_PAT }}
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ env.MOBILE_DIR }}/package-lock.json

      # EAS CLI no longer needed - using local builds
      # - name: Setup EAS CLI
      #   uses: expo/expo-github-action@v8
      #   with:
      #     eas-version: latest
      #     token: ${{ secrets.EXPO_TOKEN }}

      - name: Analyze commit messages
        id: analyze
        run: |
          # Check if manually triggered with version type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_TYPE="${{ github.event.inputs.version_type }}"
            SHOULD_RELEASE="true"
            echo "Manual trigger - using version type: $VERSION_TYPE"
            echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
            echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Automatic trigger - analyze commits
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline --format="%s" -20)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --oneline --format="%s" -- ${{ env.MOBILE_DIR }})
          fi

          echo "Analyzing commits:"
          echo "$COMMITS"

          # Determine version bump type based on commit messages
          # Major: BREAKING CHANGE or feat! or fix!
          # Minor: feat, feature, add, new
          # Patch: fix, bugfix, patch, hotfix, chore, docs, style, refactor

          VERSION_TYPE="patch"
          SHOULD_RELEASE="true"

          if echo "$COMMITS" | grep -qiE "BREAKING|feat!|fix!"; then
            VERSION_TYPE="major"
          elif echo "$COMMITS" | grep -qiE "^feat|^feature|^add|^new"; then
            VERSION_TYPE="minor"
          elif echo "$COMMITS" | grep -qiE "^fix|^bugfix|^patch|^hotfix|^chore|^docs|^style|^refactor"; then
            VERSION_TYPE="patch"
          else
            # Check if there are any mobile-related changes
            MOBILE_CHANGES=$(git diff --name-only ${LAST_TAG:-HEAD~5}..HEAD -- ${{ env.MOBILE_DIR }} | wc -l)
            if [ "$MOBILE_CHANGES" -eq 0 ]; then
              SHOULD_RELEASE="false"
            fi
          fi

          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "Determined version type: $VERSION_TYPE"
          echo "Should release: $SHOULD_RELEASE"

      - name: Get current version
        id: current_version
        if: steps.analyze.outputs.should_release == 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Bump version
        id: version
        if: steps.analyze.outputs.should_release == 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        run: |
          VERSION_TYPE="${{ steps.analyze.outputs.version_type }}"
          CURRENT="${{ steps.current_version.outputs.current_version }}"

          # Parse version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case $VERSION_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          # Check if this tag already exists and keep incrementing until we find an unused one
          cd ${{ github.workspace }}
          git fetch --tags

          TAG_SUFFIX="${{ github.event.inputs.is_qa == 'true' && '-qa' || '' }}"
          TAG_NAME="mobile-v${NEW_VERSION}${TAG_SUFFIX}"

          MAX_INCREMENT=10
          INCREMENT=0
          while git rev-parse "$TAG_NAME" >/dev/null 2>&1; do
            echo "‚ö†Ô∏è Tag $TAG_NAME already exists, incrementing patch..."
            PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            TAG_NAME="mobile-v${NEW_VERSION}${TAG_SUFFIX}"
            INCREMENT=$((INCREMENT + 1))
            
            if [ $INCREMENT -ge $MAX_INCREMENT ]; then
              echo "‚ùå Too many existing versions, something is wrong"
              exit 1
            fi
          done

          if [ $INCREMENT -gt 0 ]; then
            echo "‚úÖ Found unused version: $NEW_VERSION (incremented $INCREMENT times)"
          fi

          cd ${{ env.MOBILE_DIR }}

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
          echo "Tag name: $TAG_NAME"

          # Update package.json
          npm version $NEW_VERSION --no-git-tag-version

          # Update app.json version
          node -e "
            const fs = require('fs');
            const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            appJson.expo.version = '$NEW_VERSION';
            fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2) + '\n');
          "

      - name: Install dependencies
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        run: npm ci

      # ============================================
      # LOCAL GITHUB ACTIONS BUILD (No EAS Credits Required)
      # ============================================

      - name: Setup Java
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build != 'true' && github.event.inputs.local_build != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build != 'true' && github.event.inputs.local_build != 'true'
        uses: android-actions/setup-android@v3

      - name: Setup Expo
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build != 'true' && github.event.inputs.local_build != 'true'
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          # No token needed for local builds

      - name: Build Android APK (Local GitHub Actions Build)
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build != 'true' && github.event.inputs.local_build != 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        env:
          EXPO_PUBLIC_API_URL: "https://api.iayos.online"
        run: |
          echo "üèóÔ∏è LOCAL GITHUB ACTIONS BUILD"
          echo "‚òÅÔ∏è Building on GitHub Actions runners (no EAS credits required)"
          echo "üì¶ Production build - ready for app store distribution"

          # Generate native Android project using expo prebuild
          echo "üì± Generating native Android project..."
          npx expo prebuild --clean --platform android

          # Build release APK using Gradle
          echo "üî® Building release APK with Gradle..."
          cd android
          chmod +x ./gradlew
          ./gradlew assembleRelease --no-daemon

          # Copy APK to expected location
          echo "üì¶ Copying APK to release location..."
          cd ..
          cp android/app/build/outputs/apk/release/app-release.apk ./iayos-${{ steps.version.outputs.new_version }}.apk

          echo "‚úÖ Local build complete!"
          ls -la ./iayos-${{ steps.version.outputs.new_version }}.apk

      - name: Download APK from latest release (if using latest build)
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build == 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        run: |
          echo "‚ôªÔ∏è Attempting to use latest existing build from GitHub Releases..."
          echo ""

          # Get latest release info
          RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=1")
          
          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.[0].assets[] | select(.name | endswith(".apk")) | .browser_download_url' | head -1)
          RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.[0].tag_name')

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "‚ùå No existing APK found in latest release!"
            echo ""
            echo "üìã Options:"
            echo "   1. Run workflow again WITHOUT 'use latest build' to build fresh"
            echo ""
            exit 1
          fi

          echo "üì¶ Found APK in release: $RELEASE_TAG"
          echo "   URL: $DOWNLOAD_URL"
          echo ""

          echo "Downloading APK from: $DOWNLOAD_URL"
          curl -L --fail --retry 3 -o iayos-${{ steps.version.outputs.new_version }}.apk "$DOWNLOAD_URL"

          echo "‚úÖ APK downloaded successfully"
          ls -la iayos-${{ steps.version.outputs.new_version }}.apk

      # ============================================================================
      # GITHUB ACTIONS LOCAL BUILD - No EAS credits needed
      # ============================================================================
      - name: Add swap space for local build
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.local_build == 'true'
        run: |
          echo "üîß Adding 10GB swap space for Gradle build..."
          sudo swapoff -a || true
          sudo fallocate -l 10G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "‚úÖ Swap space added:"
          free -h

      - name: Setup JDK 17 for local build
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.local_build == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Android APK (GitHub Actions Local Build)
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.local_build == 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        run: |
          echo "üèóÔ∏è GITHUB ACTIONS LOCAL BUILD (No EAS credits needed)"
          echo "üíª Building directly on runner with optimized memory settings"
          echo ""

          # Generate native Android project
          echo "üì± Running expo prebuild..."
          npx expo prebuild --clean --platform android

          # Optimize Gradle settings for CI environment
          echo "üîß Configuring Gradle for CI build..."
          sed -i 's/org.gradle.jvmargs=.*/org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m/' android/gradle.properties
          sed -i 's/reactNativeArchitectures=.*/reactNativeArchitectures=arm64-v8a,armeabi-v7a/' android/gradle.properties
          echo "org.gradle.caching=true" >> android/gradle.properties

          echo "üìã Gradle properties:"
          grep -E "jvmargs|Architectures|parallel" android/gradle.properties
          echo ""

          # Build release APK (skip lint to save memory)
          echo "üî® Building release APK with Gradle..."
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease \
            --no-daemon \
            --max-workers=2 \
            -x lintVitalRelease \
            -x lintVitalAnalyzeRelease \
            -x lintVitalReportRelease \
            --stacktrace
          cd ..

          # Find and copy APK to expected location
          APK_PATH=$(find android/app/build/outputs -name "*.apk" -type f | head -1)
          if [ -n "$APK_PATH" ]; then
            cp "$APK_PATH" "./iayos-${{ steps.version.outputs.new_version }}.apk"
            echo "‚úÖ APK built successfully!"
            ls -lh "./iayos-${{ steps.version.outputs.new_version }}.apk"
          else
            echo "‚ùå No APK found in build outputs"
            find android/app/build/outputs -type f 2>/dev/null || echo "No outputs directory"
            exit 1
          fi

      - name: Commit version bump
        if: steps.analyze.outputs.should_release == 'true'
        id: commit_version
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Use the version that was already verified to not have an existing tag
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          TAG_NAME="${{ steps.version.outputs.tag_name }}"

          echo "üì¶ Version: $NEW_VERSION"
          echo "üè∑Ô∏è Tag: $TAG_NAME"

          echo "final_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          # Sync with remote first
          echo "üîÑ Syncing with remote before committing..."
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}

          # Apply version changes
          cd ${{ env.MOBILE_DIR }}

          npm version $NEW_VERSION --no-git-tag-version --allow-same-version

          # Update app.json version
          node -e "
            const fs = require('fs');
            const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            appJson.expo.version = '$NEW_VERSION';
            fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2) + '\n');
          "

          cd -

          # Now commit and push
          git add ${{ env.MOBILE_DIR }}/package.json ${{ env.MOBILE_DIR }}/app.json

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No version changes to commit (already at $NEW_VERSION)"
          else
            git commit -m "chore(mobile): bump version to $NEW_VERSION"
            
            # Push with retry logic
            MAX_PUSH_RETRIES=5
            PUSH_RETRY=0
            
            while [ $PUSH_RETRY -lt $MAX_PUSH_RETRIES ]; do
              echo "Attempt $((PUSH_RETRY + 1))/$MAX_PUSH_RETRIES: Pushing..."
              
              if git push origin HEAD:${{ github.ref_name }}; then
                echo "‚úÖ Successfully pushed version bump"
                break
              else
                echo "‚ö†Ô∏è Push failed, fetching and rebasing..."
                git fetch origin ${{ github.ref_name }}
                git rebase origin/${{ github.ref_name }}
                PUSH_RETRY=$((PUSH_RETRY + 1))
                sleep 2
              fi
            done
            
            if [ $PUSH_RETRY -eq $MAX_PUSH_RETRIES ]; then
              echo "‚ùå Failed to push after $MAX_PUSH_RETRIES attempts"
              echo "‚ö†Ô∏è Continuing with release - version commit may be missing"
              echo "::warning::Version bump commit was not pushed. Manual intervention may be needed."
            fi
          fi

      - name: Extract Changelog
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true'
        id: changelog
        run: |
          echo "Extracting changelog for version ${{ steps.commit_version.outputs.final_version }}"
          
          # Make script executable
          chmod +x .github/scripts/extract-changelog.sh
          
          # Extract changelog content
          CHANGELOG_OUTPUT=$(./.github/scripts/extract-changelog.sh "${{ steps.commit_version.outputs.final_version }}")
          
          # Output to GitHub Actions (multiline)
          echo "changelog_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Show extracted content in logs
          echo "üìù Changelog content extracted:"
          echo "$CHANGELOG_OUTPUT"

      - name: Create Release
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.commit_version.outputs.tag_name }}
          name: iAyos Mobile v${{ steps.commit_version.outputs.final_version }}${{ github.event.inputs.is_qa == 'true' && ' (QA)' || '' }}${{ github.event.inputs.is_prerelease == 'true' && ' (Pre-release)' || '' }}
          body: |
            ## iAyos Mobile App Release v${{ steps.commit_version.outputs.final_version }}

            **Version Type:** ${{ steps.analyze.outputs.version_type }}
            **Branch:** ${{ github.ref_name }}
            **Build Profile:** production
            **Build Type:** ${{ github.event.inputs.local_build == 'true' && 'GitHub Actions Local Build' || github.event.inputs.use_latest_build == 'true' && 'Latest Existing Build' || 'EAS Cloud Build' }}
            **Release Type:** ${{ github.event.inputs.is_qa == 'true' && 'üß™ QA Testing' || github.event.inputs.is_prerelease == 'true' && 'üöß Pre-release' || '‚úÖ Production' }}

            ### üì¶ Production Build (Local GitHub Actions)

            Built on GitHub Actions runners (no EAS credits required):
            - ‚úÖ App Store distribution ready
            - ‚úÖ Production deployment ready
            - ‚úÖ End user ready
            - üöÄ Fast local builds on GitHub infrastructure

            ### What's Changed
            ${{ steps.changelog.outputs.changelog_notes }}

            ---
            üìñ [View Full Changelog](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/apps/frontend_mobile/iayos_mobile/CHANGELOG.md)

            ### Installation
            Download the APK file below and install on your Android device.

            > ‚ö†Ô∏è You may need to enable "Install from unknown sources" in your device settings.
            ${{ github.event.inputs.is_qa == 'true' && '> üß™ **QA Build** - For internal testing only' || '' }}
          files: |
            ${{ env.MOBILE_DIR }}/iayos-${{ steps.version.outputs.new_version }}.apk
          draft: false
          prerelease: ${{ github.event.inputs.is_prerelease == 'true' || github.ref_name != 'main' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update DigitalOcean Mobile Version
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.ref_name == 'main'
        env:
          DO_API_TOKEN: ${{ secrets.DO_API_TOKEN }}
          DO_APP_ID: ${{ secrets.DO_APP_ID }}
          NEW_VERSION: ${{ steps.commit_version.outputs.final_version || steps.version.outputs.new_version }}
        run: |
          echo "üì± Updating DigitalOcean mobile version to $NEW_VERSION..."

          # Get current app spec
          echo "üìã Fetching current app spec..."
          CURRENT_SPEC=$(curl -s -X GET "https://api.digitalocean.com/v2/apps/$DO_APP_ID" \
            -H "Authorization: Bearer $DO_API_TOKEN" \
            -H "Content-Type: application/json")

          # Extract and update the spec with new mobile version env vars
          # Using jq to properly update the env vars
          UPDATED_SPEC=$(echo "$CURRENT_SPEC" | jq --arg version "$NEW_VERSION" '
            .app.spec.services[0].envs = (
              [.app.spec.services[0].envs[] | select(.key != "MOBILE_CURRENT_VERSION" and .key != "MOBILE_MIN_VERSION")] +
              [{"key": "MOBILE_CURRENT_VERSION", "value": $version, "scope": "RUN_AND_BUILD_TIME", "type": "GENERAL"},
               {"key": "MOBILE_MIN_VERSION", "value": $version, "scope": "RUN_AND_BUILD_TIME", "type": "GENERAL"}]
            ) | .app.spec'
          )

          # Update the app with new spec
          echo "üîÑ Updating app with new mobile version env vars..."
          UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "https://api.digitalocean.com/v2/apps/$DO_APP_ID" \
            -H "Authorization: Bearer $DO_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"spec\": $UPDATED_SPEC}")

          UPDATE_HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
          UPDATE_BODY=$(echo "$UPDATE_RESPONSE" | head -n-1)

          if [ "$UPDATE_HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ MOBILE_CURRENT_VERSION updated to $NEW_VERSION"
            echo "‚úÖ MOBILE_MIN_VERSION updated to $NEW_VERSION"
            echo "üöÄ DigitalOcean will automatically redeploy with new env vars!"
            echo "üîó Monitor at: https://cloud.digitalocean.com/apps/$DO_APP_ID"
          else
            echo "‚ùå Failed to update DigitalOcean app (HTTP $UPDATE_HTTP_CODE)"
            echo "Response: $UPDATE_BODY"
            echo "::warning::DigitalOcean update failed. You may need to manually update the env vars."
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Mobile Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.analyze.outputs.should_release }}" == "true" ]; then
            echo "‚úÖ **Version:** ${{ steps.commit_version.outputs.final_version || steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "üì¶ **Type:** ${{ steps.analyze.outputs.version_type }}" >> $GITHUB_STEP_SUMMARY
            echo "üèóÔ∏è **Profile:** production" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.skip_build }}" == "true" ]; then
              echo "‚ö†Ô∏è **Build:** Skipped (testing mode)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ github.event.inputs.local_build }}" == "true" ]; then
              echo "ÔøΩÔ∏è **Build:** GitHub Actions Local Build (no EAS credits)" >> $GITHUB_STEP_SUMMARY
              echo "üîó **Release:** ${{ steps.commit_version.outputs.tag_name || steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ github.event.inputs.use_latest_build }}" == "true" ]; then
              echo "‚ôªÔ∏è **Build:** Using latest existing build from GitHub Releases" >> $GITHUB_STEP_SUMMARY
              echo "üîó **Release:** ${{ steps.commit_version.outputs.tag_name || steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "üèóÔ∏è **Build:** Local GitHub Actions build (no EAS credits)" >> $GITHUB_STEP_SUMMARY
              echo "üîó **Release:** ${{ steps.commit_version.outputs.tag_name || steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚è≠Ô∏è No mobile release needed - no relevant changes detected" >> $GITHUB_STEP_SUMMARY
          fi

name: Mobile App Release

permissions:
  contents: write # Required for creating releases and pushing version commits
  packages: write # Required for package operations

on:
  # Automatic trigger on mobile code changes
  push:
    branches:
      - main
      - dev
    paths:
      - "apps/frontend_mobile/iayos_mobile/**"
      - "!apps/frontend_mobile/iayos_mobile/**/*.md"

  # Manual trigger for on-demand releases
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch
      use_latest_build:
        description: "Use latest Expo build (skip new build, just create GitHub release)"
        required: false
        default: false
        type: boolean
      skip_build:
        description: "Skip build (for testing workflow only)"
        required: false
        default: false
        type: boolean
      local_build:
        description: "Local build mode - bumps version and creates tag, but you build APK locally with Android Studio"
        required: false
        default: false
        type: boolean
      is_qa:
        description: "Mark as QA release (adds -qa suffix to tag)"
        required: false
        default: false
        type: boolean
      is_prerelease:
        description: "Mark as prerelease (draft/beta release)"
        required: false
        default: false
        type: boolean

env:
  MOBILE_DIR: apps/frontend_mobile/iayos_mobile

jobs:
  analyze-and-build:
    name: Analyze Changes & Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.commit_version.outputs.final_version || steps.version.outputs.new_version }}
      tag_name: ${{ steps.commit_version.outputs.tag_name || steps.version.outputs.tag_name }}
      version_type: ${{ steps.analyze.outputs.version_type }}
      should_release: ${{ steps.analyze.outputs.should_release }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MOBILE_RELEASE_PAT }}
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ env.MOBILE_DIR }}/package-lock.json

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Analyze commit messages
        id: analyze
        run: |
          # Check if manually triggered with version type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_TYPE="${{ github.event.inputs.version_type }}"
            SHOULD_RELEASE="true"
            echo "Manual trigger - using version type: $VERSION_TYPE"
            echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
            echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Automatic trigger - analyze commits
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline --format="%s" -20)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --oneline --format="%s" -- ${{ env.MOBILE_DIR }})
          fi

          echo "Analyzing commits:"
          echo "$COMMITS"

          # Determine version bump type based on commit messages
          # Major: BREAKING CHANGE or feat! or fix!
          # Minor: feat, feature, add, new
          # Patch: fix, bugfix, patch, hotfix, chore, docs, style, refactor

          VERSION_TYPE="patch"
          SHOULD_RELEASE="true"

          if echo "$COMMITS" | grep -qiE "BREAKING|feat!|fix!"; then
            VERSION_TYPE="major"
          elif echo "$COMMITS" | grep -qiE "^feat|^feature|^add|^new"; then
            VERSION_TYPE="minor"
          elif echo "$COMMITS" | grep -qiE "^fix|^bugfix|^patch|^hotfix|^chore|^docs|^style|^refactor"; then
            VERSION_TYPE="patch"
          else
            # Check if there are any mobile-related changes
            MOBILE_CHANGES=$(git diff --name-only ${LAST_TAG:-HEAD~5}..HEAD -- ${{ env.MOBILE_DIR }} | wc -l)
            if [ "$MOBILE_CHANGES" -eq 0 ]; then
              SHOULD_RELEASE="false"
            fi
          fi

          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "Determined version type: $VERSION_TYPE"
          echo "Should release: $SHOULD_RELEASE"

      - name: Get current version
        id: current_version
        if: steps.analyze.outputs.should_release == 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Bump version
        id: version
        if: steps.analyze.outputs.should_release == 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        run: |
          VERSION_TYPE="${{ steps.analyze.outputs.version_type }}"
          CURRENT="${{ steps.current_version.outputs.current_version }}"

          # Parse version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case $VERSION_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          
          # Check if this tag already exists and keep incrementing until we find an unused one
          cd ${{ github.workspace }}
          git fetch --tags
          
          TAG_SUFFIX="${{ github.event.inputs.is_qa == 'true' && '-qa' || '' }}"
          TAG_NAME="mobile-v${NEW_VERSION}${TAG_SUFFIX}"
          
          MAX_INCREMENT=10
          INCREMENT=0
          while git rev-parse "$TAG_NAME" >/dev/null 2>&1; do
            echo "âš ï¸ Tag $TAG_NAME already exists, incrementing patch..."
            PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            TAG_NAME="mobile-v${NEW_VERSION}${TAG_SUFFIX}"
            INCREMENT=$((INCREMENT + 1))
            
            if [ $INCREMENT -ge $MAX_INCREMENT ]; then
              echo "âŒ Too many existing versions, something is wrong"
              exit 1
            fi
          done
          
          if [ $INCREMENT -gt 0 ]; then
            echo "âœ… Found unused version: $NEW_VERSION (incremented $INCREMENT times)"
          fi
          
          cd ${{ env.MOBILE_DIR }}
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
          echo "Tag name: $TAG_NAME"

          # Update package.json
          npm version $NEW_VERSION --no-git-tag-version

          # Update app.json version
          node -e "
            const fs = require('fs');
            const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            appJson.expo.version = '$NEW_VERSION';
            fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2) + '\n');
          "

      - name: Install dependencies
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        run: npm ci

      # ============================================
      # LOCAL BUILD SETUP (No EAS Cloud Credits!)
      # ============================================
      
      - name: Setup Java JDK 17
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build != 'true' && github.event.inputs.local_build != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build != 'true' && github.event.inputs.local_build != 'true'
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708  # Latest stable
          
      - name: Accept Android Licenses
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build != 'true' && github.event.inputs.local_build != 'true'
        run: yes | sdkmanager --licenses || true

      - name: Install Android Build Tools
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build != 'true' && github.event.inputs.local_build != 'true'
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Build Android APK (Local - No EAS Credits!)
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build != 'true' && github.event.inputs.local_build != 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          BUILD_PROFILE="production"
          
          echo "ðŸ—ï¸ LOCAL BUILD with profile: $BUILD_PROFILE"
          echo "âœ… No EAS cloud credits consumed - building locally!"
          
          echo "ðŸ“¦ Production build - ready for app store distribution"
          
          # Run local build (outputs APK directly, no cloud needed!)
          # The --local flag builds on this runner instead of EAS servers
          eas build --platform android --profile $BUILD_PROFILE --local --non-interactive --output=./build-output.apk
          
          # Rename to versioned filename
          mv ./build-output.apk ./iayos-${{ steps.version.outputs.new_version }}.apk
          
          echo "âœ… Local build complete!"
          ls -la ./iayos-${{ steps.version.outputs.new_version }}.apk

      - name: Download APK from EAS (if using latest build)
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.use_latest_build == 'true'
        working-directory: ${{ env.MOBILE_DIR }}
        run: |
          echo "â™»ï¸ Attempting to use latest existing build from Expo..."
          echo ""
          echo "âš ï¸  NOTE: This option only works for CLOUD (EAS) builds!"
          echo "   Local builds are not uploaded to Expo and cannot be reused."
          echo "   If you've been using local builds, you need to build fresh."
          echo ""
          
          # Get build info
          BUILD_INFO=$(eas build:list --platform android --limit 1 --json --non-interactive 2>/dev/null || echo "[]")
          BUILD_URL=$(echo "$BUILD_INFO" | jq -r '.[0].artifacts.buildUrl // empty')
          BUILD_STATUS=$(echo "$BUILD_INFO" | jq -r '.[0].status // empty')
          BUILD_DATE=$(echo "$BUILD_INFO" | jq -r '.[0].createdAt // empty')
          
          if [ -z "$BUILD_URL" ] || [ "$BUILD_URL" = "null" ]; then
            echo "âŒ No existing EAS cloud build found!"
            echo ""
            echo "ðŸ“‹ Options:"
            echo "   1. Run workflow again WITHOUT 'use latest build' to build locally"
            echo "   2. Run 'eas build --platform android' locally to create a cloud build"
            echo ""
            exit 1
          fi
          
          echo "ðŸ“¦ Found EAS build:"
          echo "   Status: $BUILD_STATUS"
          echo "   Date: $BUILD_DATE"
          echo "   URL: $BUILD_URL"
          echo ""
          
          echo "Downloading APK from: $BUILD_URL"
          curl -L --fail --retry 3 -o iayos-${{ steps.version.outputs.new_version }}.apk "$BUILD_URL"
          
          echo "âœ… APK downloaded successfully"
          ls -la iayos-${{ steps.version.outputs.new_version }}.apk

      # ============================================================================
      # LOCAL BUILD MODE - Skip cloud build and provide instructions
      # ============================================================================
      - name: Local Build Instructions
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.local_build == 'true'
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    ðŸ—ï¸  LOCAL BUILD MODE ACTIVATED                           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Version bumped to: ${{ steps.version.outputs.new_version }}"
          echo "âœ… Tag will be created: ${{ steps.version.outputs.tag_name }}"
          echo ""
          echo "ðŸ“‹ To build the APK locally (5-10 minutes vs 30+ minutes in cloud):"
          echo ""
          echo "   Option A: Using Expo CLI (Recommended)"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "   1. git pull origin main"
          echo "   2. cd apps/frontend_mobile/iayos_mobile"
          echo "   3. npm install"
          echo "   4. npx expo prebuild --clean"
          echo "   5. npx expo run:android --variant release"
          echo ""
          echo "   Option B: Using Android Studio"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "   1. git pull origin main"
          echo "   2. cd apps/frontend_mobile/iayos_mobile"
          echo "   3. npm install"
          echo "   4. npx expo prebuild --clean"
          echo "   5. Open 'android' folder in Android Studio"
          echo "   6. Build > Generate Signed Bundle/APK > APK"
          echo "   7. Choose 'release' build variant"
          echo ""
          echo "   APK Location: android/app/build/outputs/apk/release/app-release.apk"
          echo ""
          echo "ðŸš€ After building, you can manually upload to the GitHub Release page!"
          echo ""

      - name: Commit version bump
        if: steps.analyze.outputs.should_release == 'true'
        id: commit_version
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Use the version that was already verified to not have an existing tag
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          
          echo "ðŸ“¦ Version: $NEW_VERSION"
          echo "ðŸ·ï¸ Tag: $TAG_NAME"
          
          echo "final_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # Sync with remote first
          echo "ðŸ”„ Syncing with remote before committing..."
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}
          
          # Apply version changes
          cd ${{ env.MOBILE_DIR }}
          
          npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          
          # Update app.json version
          node -e "
            const fs = require('fs');
            const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            appJson.expo.version = '$NEW_VERSION';
            fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2) + '\n');
          "
          
          cd -
          
          # Now commit and push
          git add ${{ env.MOBILE_DIR }}/package.json ${{ env.MOBILE_DIR }}/app.json
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No version changes to commit (already at $NEW_VERSION)"
          else
            git commit -m "chore(mobile): bump version to $NEW_VERSION"
            
            # Push with retry logic
            MAX_PUSH_RETRIES=5
            PUSH_RETRY=0
            
            while [ $PUSH_RETRY -lt $MAX_PUSH_RETRIES ]; do
              echo "Attempt $((PUSH_RETRY + 1))/$MAX_PUSH_RETRIES: Pushing..."
              
              if git push origin HEAD:${{ github.ref_name }}; then
                echo "âœ… Successfully pushed version bump"
                break
              else
                echo "âš ï¸ Push failed, fetching and rebasing..."
                git fetch origin ${{ github.ref_name }}
                git rebase origin/${{ github.ref_name }}
                PUSH_RETRY=$((PUSH_RETRY + 1))
                sleep 2
              fi
            done
            
            if [ $PUSH_RETRY -eq $MAX_PUSH_RETRIES ]; then
              echo "âŒ Failed to push after $MAX_PUSH_RETRIES attempts"
              echo "âš ï¸ Continuing with release - version commit may be missing"
              echo "::warning::Version bump commit was not pushed. Manual intervention may be needed."
            fi
          fi

      - name: Create Release
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.skip_build != 'true' && github.event.inputs.local_build != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.commit_version.outputs.tag_name }}
          name: iAyos Mobile v${{ steps.commit_version.outputs.final_version }}${{ github.event.inputs.is_qa == 'true' && ' (QA)' || '' }}${{ github.event.inputs.is_prerelease == 'true' && ' (Pre-release)' || '' }}
          body: |
            ## iAyos Mobile App Release v${{ steps.commit_version.outputs.final_version }}

            **Version Type:** ${{ steps.analyze.outputs.version_type }}
            **Branch:** ${{ github.ref_name }}
            **Build Profile:** production
            **Build Type:** ${{ github.event.inputs.use_latest_build == 'true' && 'Latest Existing Build' || 'Newly Built' }}
            **Release Type:** ${{ github.event.inputs.is_qa == 'true' && 'ðŸ§ª QA Testing' || github.event.inputs.is_prerelease == 'true' && 'ðŸš§ Pre-release' || 'âœ… Production' }}

            ### ðŸ“¦ Production Build

            Optimized release ready for:
            - âœ… App Store distribution
            - âœ… Production deployment
            - âœ… End users

            ### Changes
            See commit history for detailed changes.

            ### Installation
            Download the APK file below and install on your Android device.

            > âš ï¸ You may need to enable "Install from unknown sources" in your device settings.
            ${{ github.event.inputs.is_qa == 'true' && '> ðŸ§ª **QA Build** - For internal testing only' || '' }}
          files: |
            ${{ env.MOBILE_DIR }}/iayos-${{ steps.version.outputs.new_version }}.apk
          draft: false
          prerelease: ${{ github.event.inputs.is_prerelease == 'true' || github.ref_name != 'main' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "## Mobile Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.analyze.outputs.should_release }}" == "true" ]; then
            echo "âœ… **Version:** ${{ steps.commit_version.outputs.final_version || steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **Type:** ${{ steps.analyze.outputs.version_type }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ—ï¸ **Profile:** production" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.skip_build }}" == "true" ]; then
              echo "âš ï¸ **Build:** Skipped (testing mode)" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ github.event.inputs.local_build }}" == "true" ]; then
              echo "ðŸ  **Build:** Local build mode - Build APK locally with Android Studio" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ—ï¸ Local Build Instructions" >> $GITHUB_STEP_SUMMARY
              echo "1. \`git pull origin main\`" >> $GITHUB_STEP_SUMMARY
              echo "2. \`cd apps/frontend_mobile/iayos_mobile\`" >> $GITHUB_STEP_SUMMARY
              echo "3. \`npm install\`" >> $GITHUB_STEP_SUMMARY
              echo "4. \`npx expo prebuild --clean\`" >> $GITHUB_STEP_SUMMARY
              echo "5. \`npx expo run:android --variant release\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“ APK: \`android/app/build/outputs/apk/release/app-release.apk\`" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ github.event.inputs.use_latest_build }}" == "true" ]; then
              echo "â™»ï¸ **Build:** Using latest existing build" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”— **Release:** ${{ steps.commit_version.outputs.tag_name || steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ—ï¸ **Build:** Newly built" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”— **Release:** ${{ steps.commit_version.outputs.tag_name || steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ No mobile release needed - no relevant changes detected" >> $GITHUB_STEP_SUMMARY
          fi

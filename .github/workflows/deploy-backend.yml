name: "Deploy Backend to Render"

on:
  push:
    branches: ["main"]
    paths:
      # Only deploy when backend code changes
      - "apps/backend/**"
      - "Dockerfile"
      - "docker-compose.yml"
      - "requirements.txt"
      - ".env.docker.example"
      # Exclude documentation changes
      - "!apps/backend/**/*.md"
      - "!apps/backend/README.md"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deployment regardless of changes"
        required: false
        default: "false"

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed files
        id: changes
        run: |
          echo "Files changed in backend:"
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^apps/backend/" || echo "No backend changes"

      - name: Trigger Render deployment
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "âŒ Error: RENDER_DEPLOY_HOOK secret not set"
            echo "Please add your Render deploy hook URL to GitHub Secrets"
            exit 1
          fi

          echo "ðŸš€ Triggering Render deployment..."

          response=$(curl -s -w "\n%{http_code}" -X POST "$RENDER_DEPLOY_HOOK")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "âœ… Deployment triggered successfully!"
            echo "ðŸ”— Check status at: https://dashboard.render.com"
          else
            echo "âŒ Deployment trigger failed with status $http_code"
            exit 1
          fi

      - name: Wait for deployment (optional)
        run: |
          echo "â³ Deployment initiated. This may take 5-10 minutes."
          echo "Monitor progress at: https://dashboard.render.com"

      - name: Notify deployment started
        if: success()
        run: |
          echo "::notice title=ðŸš€ Deployment Started::Backend deployment to Render initiated successfully. Monitor at https://dashboard.render.com"

      - name: Notify deployment failed
        if: failure()
        run: |
          echo "::error title=âŒ Deployment Failed::Backend deployment to Render failed. Check logs for details."
      
      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… Deployment Triggered Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— [Monitor deployment on Render Dashboard](https://dashboard.render.com)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Estimated time**: 5-10 minutes" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Live URL**: https://api.iayos.online" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      # Optional: Uncomment to enable Slack notifications
      # - name: Send Slack notification
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: |
      #       Backend deployment to Render ${{ job.status }}
      #       Commit: ${{ github.sha }}
      #       Author: ${{ github.actor }}
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      # Optional: Uncomment to enable Discord notifications  
      # - name: Send Discord notification
      #   if: always()
      #   uses: sarisia/actions-status-discord@v1
      #   with:
      #     webhook: ${{ secrets.DISCORD_WEBHOOK }}
      #     status: ${{ job.status }}
      #     title: "Backend Deployment"
      #     description: "Deployment to Render ${{ job.status }}"
      #     url: https://dashboard.render.com

# Maestro E2E Tests for iAyos Mobile
# Uses release APK from GitHub releases and live backend
# Documentation: https://maestro.mobile.dev/

name: Maestro E2E Tests

on:
  # Auto-trigger after mobile-release workflow completes
  # This ensures we test the NEW APK, not the old one
  workflow_run:
    workflows: ["Mobile App Release"]
    types: [completed]
    branches: [main, dev]

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      test_suite:
        description: "Test suite to run"
        required: false
        default: "auth"
        type: choice
        options:
          - auth
          - jobs_worker
          - jobs_client
          - wallet
          - kyc
          - profile
          - all
      apk_version:
        description: "APK version tag (leave empty for latest)"
        required: false
        default: ""
        type: string

  # Run on PRs affecting mobile (tests against latest release APK)
  pull_request:
    branches:
      - main
      - dev
    paths:
      - "apps/frontend_mobile/**"
      - ".maestro/**"

# Cancel in-progress runs for the same branch
concurrency:
  group: maestro-${{ github.ref }}
  cancel-in-progress: true

env:
  # Live backend URL
  API_URL: "https://api.iayos.online"
  # App package name (must match app.json and build.gradle)
  APP_ID: "com.devante.iayos"
  # Test database connection (set in GitHub Secrets)
  # This tells the backend to use the test database instead of production
  # Database name MUST contain "test" for cleanup endpoint to work
  DATABASE_TEST_URL: ${{ secrets.DATABASE_TEST_URL }}

jobs:
  maestro-tests:
    name: Run Maestro E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run if:
    # - Manual trigger (workflow_dispatch)
    # - PR trigger (pull_request)
    # - Mobile release completed successfully (workflow_run)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. CHECKOUT & SETUP
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. INSTALL MAESTRO CLI
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Verify Maestro installation
        run: |
          export PATH="$HOME/.maestro/bin:$PATH"
          maestro --version

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. DOWNLOAD RELEASE APK
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download latest release APK
        id: download_apk
        run: |
          # Determine which version to download
          if [ -n "${{ github.event.inputs.apk_version }}" ]; then
            VERSION="${{ github.event.inputs.apk_version }}"
            echo "Using specified version: $VERSION"
          else
            # Get latest release tag
            echo "Fetching latest release..."
            VERSION=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')
            
            # Check if we got a valid version
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "::error::No releases found in repository"
              echo "Please create a release first:"
              echo "1. Push to main branch to trigger mobile-release workflow"
              echo "2. Wait for EAS build to complete"
              echo "3. Release will be created automatically with APK"
              echo "Or create a manual release with an APK file attached"
              exit 1
            fi
            
            echo "Using latest version: $VERSION"
          fi

          mkdir -p artifacts

          # Try multiple download strategies
          DOWNLOADED=false

          # Strategy 1: Try iayos-{version}.apk naming
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/iayos-${VERSION}.apk"
          echo "Trying: $DOWNLOAD_URL"
          if curl -L --fail -o artifacts/app-release.apk "$DOWNLOAD_URL" 2>/dev/null; then
            DOWNLOADED=true
            echo "âœ“ Downloaded using naming pattern: iayos-${VERSION}.apk"
          fi

          # Strategy 2: Try app-release.apk naming
          if [ "$DOWNLOADED" = false ]; then
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/app-release.apk"
            echo "Trying: $DOWNLOAD_URL"
            if curl -L --fail -o artifacts/app-release.apk "$DOWNLOAD_URL" 2>/dev/null; then
              DOWNLOADED=true
              echo "âœ“ Downloaded using naming pattern: app-release.apk"
            fi
          fi

          # Strategy 3: Get any .apk from release assets
          if [ "$DOWNLOADED" = false ]; then
            echo "Trying to find any .apk in release assets..."
            APK_URL=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${VERSION} | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url' | head -1)
            
            if [ -n "$APK_URL" ] && [ "$APK_URL" != "null" ]; then
              echo "Found APK at: $APK_URL"
              curl -L --fail -o artifacts/app-release.apk "$APK_URL"
              DOWNLOADED=true
              echo "âœ“ Downloaded from release assets"
            fi
          fi

          # Check if download succeeded
          if [ "$DOWNLOADED" = false ]; then
            echo "::error::Could not find APK in release ${VERSION}"
            echo "Available assets:"
            curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${VERSION} | jq -r '.assets[] | .name'
            exit 1
          fi

          # Validate downloaded file
          if [ ! -f artifacts/app-release.apk ]; then
            echo "::error::APK file was not created"
            exit 1
          fi

          FILE_SIZE=$(stat -c%s artifacts/app-release.apk 2>/dev/null || stat -f%z artifacts/app-release.apk 2>/dev/null || echo 0)
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "::error::APK file too small ($FILE_SIZE bytes) - likely an error page"
            echo "File contents:"
            head -100 artifacts/app-release.apk
            exit 1
          fi

          echo "âœ“ APK downloaded successfully: $FILE_SIZE bytes"
          echo "apk_path=artifacts/app-release.apk" >> $GITHUB_OUTPUT
          ls -lh artifacts/

      - name: Verify APK
        run: |
          file artifacts/app-release.apk
          # Check if it's a valid APK (zip file with AndroidManifest)
          unzip -l artifacts/app-release.apk | head -20

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. SETUP ANDROID EMULATOR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create and start emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          target: google_apis
          arch: x86_64
          profile: pixel_5
          avd-name: maestro_avd
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none
          disable-animations: true
          script: |
            echo "Emulator started successfully"
            adb devices

            # Wait for emulator to be fully ready
            adb wait-for-device
            sleep 10

            # Disable animations for faster tests
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0

            # Install the APK
            echo "Installing APK..."
            adb install -r artifacts/app-release.apk

            # Verify installation
            adb shell pm list packages | grep iayos || echo "Warning: Package not found"

            # Run Maestro tests (combined into single command to preserve variables)
            export PATH="$HOME/.maestro/bin:$PATH" && TEST_SUITE="${{ github.event.inputs.test_suite || 'auth' }}" && MAESTRO_DIR="apps/frontend_mobile/iayos_mobile/.maestro" && echo "ğŸ“± Running Maestro tests for suite: $TEST_SUITE" && echo "ğŸ“‚ Maestro directory: $MAESTRO_DIR" && if [ "$TEST_SUITE" = "all" ]; then echo "Running all test suites..." && maestro test "$MAESTRO_DIR" --format junit --output maestro-report.xml; else echo "Running $TEST_SUITE test suite..." && maestro test "$MAESTRO_DIR/$TEST_SUITE" --format junit --output maestro-report.xml; fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4.5. CLEANUP TEST DATA
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cleanup Maestro test data
        if: always()
        continue-on-error: true
        run: |
          echo "ğŸ§¹ Cleaning up Maestro test data..."

          # Call cleanup endpoint (works only in non-production)
          CLEANUP_RESPONSE=$(curl -s -X DELETE \
            "${{ env.API_URL }}/api/mobile/test/cleanup-maestro-data" \
            -H "Content-Type: application/json" \
            2>&1) || true

          echo "Cleanup response: $CLEANUP_RESPONSE"

          # Check if cleanup was successful
          if echo "$CLEANUP_RESPONSE" | grep -q '"success": true'; then
            echo "âœ… Test data cleanup completed successfully"
            echo "$CLEANUP_RESPONSE" | jq -r '.stats // empty' 2>/dev/null || true
          elif echo "$CLEANUP_RESPONSE" | grep -q 'not allowed'; then
            echo "â„¹ï¸ Cleanup skipped (production environment)"
          else
            echo "âš ï¸ Cleanup may have failed or was not needed"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. COLLECT RESULTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-test-results
          path: |
            maestro-report.xml
            ~/.maestro/tests/**/*.png
            ~/.maestro/tests/**/*.mp4
          retention-days: 14

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots
          path: ~/.maestro/tests/**/screenshots/
          retention-days: 14
          if-no-files-found: ignore

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. PUBLISH RESULTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Publish test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: "maestro-report.xml"
          fail_on_failure: true
          require_tests: true
          check_name: "Maestro E2E Test Results"

      - name: Comment on PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let status = 'âœ… Passed';
            let details = 'All E2E tests passed successfully!';

            // Check if tests failed
            if (process.env.TEST_RESULT !== '0') {
              status = 'âŒ Failed';
              details = 'Some E2E tests failed. Check the workflow logs for details.';
            }

            const body = `## Maestro E2E Test Results ${status}

            **Test Suite:** \`${{ github.event.inputs.test_suite || 'auth' }}\`
            **Backend:** \`${{ env.API_URL }}\`

            ${details}

            ğŸ“¦ [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. CREATE GITHUB ISSUE ON TEST FAILURE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create issue on test failure
        if: failure() && steps.download_apk.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read test results if available
            let testDetails = 'Test execution failed. Check workflow logs for details.';
            let failedTests = [];

            try {
              if (fs.existsSync('maestro-report.xml')) {
                const xml = fs.readFileSync('maestro-report.xml', 'utf8');
                
                // Parse basic failure info from JUnit XML
                const failureMatches = xml.match(/<testcase[^>]*name="([^"]+)"[^>]*>[\s\S]*?<failure[^>]*>([\s\S]*?)<\/failure>/g);
                
                if (failureMatches) {
                  failedTests = failureMatches.map(match => {
                    const nameMatch = match.match(/name="([^"]+)"/);
                    const messageMatch = match.match(/<failure[^>]*>([\s\S]*?)<\/failure>/);
                    return {
                      name: nameMatch ? nameMatch[1] : 'Unknown',
                      message: messageMatch ? messageMatch[1].trim() : 'No details'
                    };
                  });
                  
                  testDetails = failedTests.map((test, i) => 
                    `${i + 1}. **${test.name}**\n   \`\`\`\n   ${test.message}\n   \`\`\``
                  ).join('\n\n');
                }
              }
            } catch (error) {
              console.log('Could not parse test results:', error.message);
            }

            // Get APK version from environment or use "latest"
            const apkVersion = '${{ github.event.inputs.apk_version }}' || 'latest';
            const testSuite = '${{ github.event.inputs.test_suite }}' || 'auth';

            // Check if issue already exists for this failure
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'e2e-test-failure,mobile',
              state: 'open'
            });

            const similarIssue = existingIssues.find(issue => 
              issue.title.includes(`[Maestro E2E]`) && 
              issue.title.includes(testSuite)
            );

            if (similarIssue) {
              // Add comment to existing issue instead of creating new one
              const commentBody = [
                '## ğŸ”„ Test Failed Again',
                '',
                '**Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})',
                '**Date:** ' + new Date().toISOString().split('T')[0],
                '**Commit:** ${{ github.sha }}',
                '',
                '### Failed Tests',
                testDetails,
                '',
                'This issue is still occurring. The test suite `' + testSuite + '` continues to fail.'
              ].join('\n');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: similarIssue.number,
                body: commentBody
              });
              
              console.log('Added comment to existing issue #' + similarIssue.number);
            } else {
              // Create new issue
              const issueTitle = '[Maestro E2E] ' + testSuite + ' test suite failing';
              
              const issueBody = [
                '## ğŸ› Maestro E2E Test Failure',
                '',
                '**Test Suite:** `' + testSuite + '`',
                '**APK Version:** `' + apkVersion + '`',
                '**Backend:** `${{ env.API_URL }}`',
                '**Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})',
                '**Triggered by:** ${{ github.event_name }} on `${{ github.ref_name }}`',
                '**Commit:** ${{ github.sha }}',
                '',
                '### Failed Tests',
                testDetails,
                '',
                '### Reproduction Steps',
                '1. Download APK from [release ' + apkVersion + '](https://github.com/${{ github.repository }}/releases)',
                '2. Install on Android device/emulator (API 31)',
                '3. Run test suite: `maestro test .maestro/' + testSuite + '`',
                '',
                '### Artifacts',
                '- [ğŸ“¦ Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})',
                '- Screenshots and videos available in workflow artifacts',
                '',
                '### Environment',
                '- Android API Level: 31',
                '- Device Profile: Pixel 5',
                '- Emulator: x86_64',
                '- Backend: Production (api.iayos.online)',
                '',
                '---',
                '**Auto-generated by Maestro E2E Tests workflow**'
              ].join('\n');

              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['bug', 'mobile', 'e2e-test-failure', 'automated']
              });
              
              console.log('Created issue #' + issue.number + ': ' + issueTitle);
            }

name: ðŸ§ª Mobile E2E Tests (Detox)

on:
  # Only manual trigger for now until CI is stable
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to test"
        required: true
        default: "android"
        type: choice
        options:
          - android
          - ios
          - both

env:
  STAGING_BACKEND_URL: ${{ secrets.STAGING_BACKEND_URL || 'http://localhost:8000' }}
  EXPO_PUBLIC_API_URL: ${{ secrets.STAGING_BACKEND_URL || 'http://localhost:8000' }}

jobs:
  test-android:
    if: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' }}
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ðŸ“± Enable KVM (for Android Emulator)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: ðŸ“¦ Install dependencies
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Installing dependencies with legacy-peer-deps..."
          npm ci --legacy-peer-deps --prefer-offline || npm install --legacy-peer-deps
        timeout-minutes: 10

      - name: ðŸ“ Create artifact directories
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          mkdir -p e2e/reports
          mkdir -p e2e/artifacts
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/reports/.gitkeep.json
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/artifacts/.gitkeep.json

      - name: ðŸ”§ Generate native Android project (Expo Prebuild)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: npx expo prebuild --platform android --clean

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“± Create Android Emulator
        run: |
          echo "Installing system image..."
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-31;google_apis;x86_64"
          
          echo "Available device definitions:"
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list device | grep -i pixel || echo "No Pixel devices found"
          
          echo "Creating AVD..."
          # Try with pixel_5 device, if that fails, create without device specification
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n Pixel_5_API_31 \
            -k "system-images;android-31;google_apis;x86_64" \
            -d "pixel_5" \
            --force || \
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n Pixel_5_API_31 \
            -k "system-images;android-31;google_apis;x86_64" \
            --force
          
          echo "Verifying AVD was created..."
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd
          
          if [ ! -f "$HOME/.android/avd/Pixel_5_API_31.ini" ]; then
            echo "ERROR: AVD was not created successfully"
            echo "Available AVDs:"
            $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd
            exit 1
          fi
          echo "âœ… AVD created successfully"

      - name: ðŸš€ Start Android Emulator
        run: |
          echo "Starting emulator..."
          $ANDROID_HOME/emulator/emulator -avd Pixel_5_API_31 -no-snapshot-save -no-window -gpu swiftshader_indirect -no-audio -no-boot-anim &
          # Wait for device with timeout
          timeout 120 adb wait-for-device || (echo "Emulator failed to start" && exit 1)
          # Wait for boot complete
          for i in {1..60}; do
            BOOT=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$BOOT" = "1" ]; then
              echo "Emulator booted successfully"
              break
            fi
            echo "Waiting for boot... ($i/60)"
            sleep 2
          done
          adb devices

      - name: ðŸ”¨ Build Android app for testing
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          cd android
          ./gradlew assembleDebug assembleAndroidTest -DtestBuildType=debug --no-daemon
        timeout-minutes: 15

      - name: ðŸ§ª Run Detox E2E tests (Android)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          npx detox test --configuration android.emu.debug --headless --record-logs all --take-screenshots failing 2>&1 | tee e2e/reports/test-output.log || true
        timeout-minutes: 15
        id: detox_tests_android

      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-test-report
          path: |
            apps/frontend_mobile/iayos_mobile/e2e/reports/
            apps/frontend_mobile/iayos_mobile/e2e/artifacts/
          retention-days: 14
          if-no-files-found: warn

  test-ios:
    if: ${{ github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' }}
    runs-on: macos-14
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: ðŸŽ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: ðŸ“¦ Install dependencies
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Installing dependencies with legacy-peer-deps..."
          npm ci --legacy-peer-deps --prefer-offline || npm install --legacy-peer-deps
        timeout-minutes: 10

      - name: ðŸ“ Create artifact directories
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          mkdir -p e2e/reports
          mkdir -p e2e/artifacts
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/reports/.gitkeep.json
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/artifacts/.gitkeep.json

      - name: ðŸ”§ Generate native iOS project (Expo Prebuild)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: npx expo prebuild --platform ios --clean

      - name: ðŸ“± Install CocoaPods dependencies
        working-directory: apps/frontend_mobile/iayos_mobile/ios
        run: pod install

      - name: ðŸº Install Detox CLI tools
        run: brew tap wix/brew && brew install applesimutils

      - name: ðŸ“± Boot iPhone 15 Simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 (" | head -1 | grep -oE '\(([A-F0-9-]+)\)' | tr -d '()')
          if [ -z "$DEVICE_ID" ]; then
            echo "iPhone 15 not found, creating..."
            RUNTIME=$(xcrun simctl list runtimes | grep "iOS 17" | tail -1 | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+')
            xcrun simctl create "iPhone 15" "iPhone 15" "$RUNTIME"
            DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 (" | head -1 | grep -oE '\(([A-F0-9-]+)\)' | tr -d '()')
          fi
          echo "Booting simulator: $DEVICE_ID"
          xcrun simctl boot "$DEVICE_ID" || true
          xcrun simctl bootstatus "$DEVICE_ID" -b
        timeout-minutes: 5

      - name: ðŸ”¨ Build iOS app for testing
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          xcodebuild -workspace ios/iayosmobile.xcworkspace \
            -scheme iayosmobile \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath ios/build \
            -quiet \
            build
        timeout-minutes: 20

      - name: ðŸ§ª Run Detox E2E tests (iOS)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          npx detox test --configuration ios.sim.debug --headless --record-logs all --take-screenshots failing 2>&1 | tee e2e/reports/test-output.log || true
        timeout-minutes: 15
        id: detox_tests

      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-test-report
          path: |
            apps/frontend_mobile/iayos_mobile/e2e/reports/
            apps/frontend_mobile/iayos_mobile/e2e/artifacts/
          retention-days: 14
          if-no-files-found: warn

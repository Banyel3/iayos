name: Mobile E2E Tests

on:
  # Manual trigger - stable for Android, iOS still experimental
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to test"
        required: true
        default: "android"
        type: choice
        options:
          - android
          - ios
          - both

env:
  STAGING_BACKEND_URL: ${{ secrets.STAGING_BACKEND_URL || 'http://localhost:8000' }}
  EXPO_PUBLIC_API_URL: ${{ secrets.STAGING_BACKEND_URL || 'http://localhost:8000' }}

jobs:
  test-android:
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: üì± Enable KVM (for Android Emulator)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: üì¶ Install dependencies
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Installing dependencies with legacy-peer-deps..."
          npm ci --legacy-peer-deps --prefer-offline || npm install --legacy-peer-deps
        timeout-minutes: 10

      - name: üìÅ Create artifact directories
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          mkdir -p e2e/reports
          mkdir -p e2e/artifacts
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/reports/.gitkeep.json
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/artifacts/.gitkeep.json

      - name: üîß Generate native Android project (Expo Prebuild)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: npx expo prebuild --platform android --clean

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: üì± Install Android System Image
        run: |
          echo "Installing Android 31 system image..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-31;google_apis;x86_64"
          echo "‚úÖ System image installed"

      - name: üîß Create Android AVD
        run: |
          echo "=== AVD Creation Diagnostics ==="
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "HOME: $HOME"
          echo "ANDROID_AVD_HOME: ${ANDROID_AVD_HOME:-not set}"

          echo ""
          echo "Setting ANDROID_AVD_HOME to ensure emulator can find AVD..."
          export ANDROID_AVD_HOME=$HOME/.android/avd
          mkdir -p $ANDROID_AVD_HOME
          echo "ANDROID_AVD_HOME set to: $ANDROID_AVD_HOME"

          echo ""
          echo "Creating AVD without device profile (generic)..."
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n test_avd \
            -k "system-images;android-31;google_apis;x86_64" \
            --force

          echo ""
          echo "Listing created AVDs..."
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd

          echo ""
          echo "Checking AVD files..."
          ls -la $HOME/.android/avd/ || echo "Directory does not exist"

          echo ""
          echo "‚úÖ AVD created successfully"

      - name: üöÄ Start Android Emulator
        run: |
          echo "=== Emulator startup diagnostics ==="
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "HOME: $HOME"

          echo "Setting ANDROID_AVD_HOME for emulator..."
          export ANDROID_AVD_HOME=$HOME/.android/avd
          echo "ANDROID_AVD_HOME: $ANDROID_AVD_HOME"

          echo ""
          echo "Listing available AVDs before starting..."
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd || echo "Failed to list AVDs"

          echo ""
          echo "ADB version:"
          adb version
          echo "Emulator location: $ANDROID_HOME/emulator/emulator"
          ls -la $ANDROID_HOME/emulator/emulator

          echo ""
          echo "Starting adb server explicitly..."
          adb start-server
          sleep 2
          adb devices

          echo ""
          echo "Starting emulator with verbose logging..."
          nohup $ANDROID_HOME/emulator/emulator -avd test_avd \
            -no-snapshot-save \
            -no-window \
            -gpu swiftshader_indirect \
            -noaudio \
            -no-boot-anim \
            -camera-back none \
            -camera-front none \
            -memory 2048 \
            -partition-size 2048 \
            -verbose \
            -qemu -enable-kvm > /tmp/emulator.log 2>&1 &

          EMULATOR_PID=$!
          echo "Emulator started with PID: $EMULATOR_PID"

          echo ""
          echo "Waiting for emulator device to appear (max 2 minutes)..."
          DEVICE_FOUND=false
          for i in {1..24}; do
            ADB_DEVICES=$(adb devices | grep -v "List of devices" | grep "emulator" || echo "")
            if [ -n "$ADB_DEVICES" ]; then
              DEVICE_FOUND=true
              echo "‚úÖ Device appeared after ~$((i*5)) seconds"
              echo "Devices: $ADB_DEVICES"
              break
            fi
            echo "Attempt $i/24: No device yet..."
            if [ $i -eq 12 ]; then
              echo "=== Checking emulator process ==="
              ps aux | grep emulator | grep -v grep || echo "Emulator process not found!"
              echo "=== First 50 lines of emulator log ==="
              head -50 /tmp/emulator.log || true
            fi
            sleep 5
          done

          if [ "$DEVICE_FOUND" = "false" ]; then
            echo ""
            echo "‚ùå Emulator device never appeared in adb devices"
            echo "=== Full emulator log ==="
            cat /tmp/emulator.log || true
            echo ""
            echo "=== Emulator process check ==="
            ps aux | grep emulator | grep -v grep || echo "Process not running"
            exit 1
          fi

          echo ""
          echo "Waiting for device to be online..."
          adb wait-for-device

          echo ""
          echo "Waiting for boot to complete (max 5 minutes)..."
          BOOT_COMPLETED=false
          for i in {1..60}; do
            BOOT_STATUS=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
            if [ "$BOOT_STATUS" = "1" ]; then
              BOOT_COMPLETED=true
              echo "‚úÖ Boot completed after ~$((i*5)) seconds"
              break
            fi
            if [ $((i % 6)) -eq 0 ]; then
              echo "Still waiting... attempt $i/60 (boot_completed='$BOOT_STATUS')"
            fi
            sleep 5
          done

          if [ "$BOOT_COMPLETED" = "false" ]; then
            echo ""
            echo "‚ùå Emulator failed to boot within timeout"
            echo "=== Device properties ==="
            adb shell getprop || true
            echo ""
            echo "=== Emulator log ==="
            cat /tmp/emulator.log || true
            exit 1
          fi

          echo ""
          echo "Unlocking screen..."
          adb shell input keyevent 82

          echo "Disabling animations for faster tests..."
          adb shell settings put global window_animation_scale 0
          adb shell settings put global transition_animation_scale 0
          adb shell settings put global animator_duration_scale 0

          echo ""
          echo "‚úÖ Emulator fully ready"
          adb devices -l

      - name: üèóÔ∏è Build Android app for testing
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          cd android

          echo "Configuring Gradle for CI build..."
          export GRADLE_OPTS="-Xmx4g -Xms512m -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"

          echo "Building for x86_64 ONLY (emulator architecture - skipping arm64, armeabi, x86)..."
          echo "This reduces native build time by ~75% (1 arch instead of 4)"

          ./gradlew :app:assembleDebug :app:assembleDebugAndroidTest \
            -DtestBuildType=debug \
            -PreactNativeArchitectures=x86_64 \
            --no-daemon \
            --max-workers=2 \
            --parallel \
            -x lint \
            -x lintVitalAnalyzeRelease \
            -x lintVitalReportRelease \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=1g" \
            || {
              echo "‚ùå Build failed, retrying with --stacktrace..."
              ./gradlew :app:assembleDebug :app:assembleDebugAndroidTest \
                -DtestBuildType=debug \
                -PreactNativeArchitectures=x86_64 \
                --no-daemon \
                --stacktrace \
                --max-workers=1 \
                -x lint
            }
        timeout-minutes: 20

      - name: üß™ Run Detox E2E Tests
        id: detox_tests
        working-directory: apps/frontend_mobile/iayos_mobile
        continue-on-error: true
        run: |
          echo "Installing Detox CLI..."
          npm install -g detox-cli

          # Create reports directory
          mkdir -p e2e/reports

          echo "Running Detox tests on emulator with JSON output..."
          # Use Jest's built-in --json flag instead of jest-json-reporter
          detox test \
            --configuration android.emu.debug \
            --headless \
            --record-logs all \
            --take-screenshots all \
            --record-videos failing \
            --loglevel verbose \
            -- --json --outputFile=e2e/reports/jest-test-results.json
        timeout-minutes: 15

      - name: ÔøΩ Debug: Check test results file
        if: always()
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Checking for test results file..."
          if [ -f "e2e/reports/jest-test-results.json" ]; then
            echo "‚úÖ Test results file exists"
            echo "File size: $(wc -c < e2e/reports/jest-test-results.json) bytes"
            echo "First 500 characters:"
            head -c 500 e2e/reports/jest-test-results.json
            echo ""
          else
            echo "‚ùå Test results file not found"
            echo "Contents of e2e/reports directory:"
            ls -la e2e/reports/ || echo "Directory doesn't exist"
          fi

      - name: ÔøΩüêõ Create GitHub Issues for Test Failures
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Parse Jest test results (Detox uses Jest)
            let testResults;
            try {
              const resultsPath = 'apps/frontend_mobile/iayos_mobile/e2e/reports/jest-test-results.json';
              if (!fs.existsSync(resultsPath)) {
                console.log('‚ÑπÔ∏è  No test results file found - tests may not have run or workflow failed');
                console.log('   Not creating issues for workflow/infrastructure failures');
                return;
              }
              testResults = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            } catch (error) {
              console.log('‚ÑπÔ∏è  Could not read test results:', error.message);
              console.log('   Not creating issues for workflow/infrastructure failures');
              return;
            }

            // Extract failed tests
            const failedTests = [];
            testResults.testResults?.forEach(testFile => {
              testFile.assertionResults?.forEach(test => {
                if (test.status === 'failed') {
                  failedTests.push({
                    testFile: testFile.name,
                    testName: test.fullName || test.title,
                    error: test.failureMessages?.join('\n') || 'No error message',
                    duration: test.duration
                  });
                }
              });
            });

            if (failedTests.length === 0) {
              console.log('‚úÖ No failed tests found in results (tests may have passed on retry)');
              return;
            }

            console.log(`Found ${failedTests.length} failed test(s)`);

            // Get existing issues to avoid duplicates
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2e-test,automated',
              per_page: 100
            });

            // Create issues for each failed test (limit to 10 to avoid spam)
            const maxIssues = Math.min(failedTests.length, 10);
            let createdCount = 0;

            for (let i = 0; i < maxIssues; i++) {
              const test = failedTests[i];
              const issueTitle = `üî¥ E2E Test Failed: ${test.testName}`;
              
              // Check if issue already exists
              const isDuplicate = existingIssues.data.some(issue => 
                issue.title === issueTitle
              );
              
              if (isDuplicate) {
                console.log(`‚è≠Ô∏è  Skipping duplicate issue: ${issueTitle}`);
                continue;
              }
              
              // Format error message
              const errorLines = test.error.split('\n');
              const errorPreview = errorLines.slice(0, 50).join('\n');
              const isTruncated = errorLines.length > 50;
              
              const issueBody = `## Test Failure Details

            **Test File:** \`${test.testFile}\`
            **Test Name:** ${test.testName}
            **Duration:** ${test.duration}ms

            ### Error Message

            \`\`\`
            ${errorPreview}${isTruncated ? '\n\n... (truncated, see workflow logs for full error)' : ''}
            \`\`\`

            ### Test Run Information

            - **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **Platform:** Android (x86_64 emulator)
            - **Configuration:** android.emu.debug
            - **Triggered by:** @${context.actor}
            - **Branch:** ${context.ref.replace('refs/heads/', '')}
            - **Commit:** ${context.sha.substring(0, 7)}

            ### Artifacts

            Check the workflow run for:
            - üì∏ Screenshots
            - üìù Test logs
            - üìπ Videos (if available)

            ### Next Steps

            1. Review the error message and stack trace
            2. Check if this is a flaky test (search for previous occurrences)
            3. Reproduce locally: \`npm run test:e2e:android\`
            4. Fix the test or the underlying code
            5. Close this issue once resolved

            ---

            **Auto-generated by Mobile E2E Tests workflow**`;
              
              try {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['bug', 'e2e-test', 'automated', 'mobile', 'android']
                });
                createdCount++;
                console.log(`‚úÖ Created issue: ${issueTitle}`);
              } catch (error) {
                console.error(`‚ùå Failed to create issue for ${test.testName}:`, error.message);
              }
            }

            if (failedTests.length > maxIssues) {
              console.log(`‚ö†Ô∏è  Only created ${maxIssues} issues out of ${failedTests.length} failures to avoid spam`);
            }

            console.log(`üìä Summary: Created ${createdCount} new issue(s) for failed tests`);

      - name: üìä Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-test-report
          path: |
            apps/frontend_mobile/iayos_mobile/e2e/reports/
            apps/frontend_mobile/iayos_mobile/e2e/artifacts/
          retention-days: 14
          if-no-files-found: warn

  test-ios:
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'
    runs-on: macos-14
    timeout-minutes: 45

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: üçé Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: üì¶ Install dependencies
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Installing dependencies with legacy-peer-deps..."
          npm ci --legacy-peer-deps --prefer-offline || npm install --legacy-peer-deps
        timeout-minutes: 10

      - name: üìÅ Create artifact directories
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          mkdir -p e2e/reports
          mkdir -p e2e/artifacts
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/reports/.gitkeep.json
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/artifacts/.gitkeep.json

      - name: üîß Generate native iOS project (Expo Prebuild)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: npx expo prebuild --platform ios --clean

      - name: üì± Install CocoaPods dependencies
        working-directory: apps/frontend_mobile/iayos_mobile/ios
        run: pod install

      - name: üç∫ Install Detox CLI tools
        run: brew tap wix/brew && brew install applesimutils

      - name: üì± Boot iPhone 15 Simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 (" | head -1 | grep -oE '\(([A-F0-9-]+)\)' | tr -d '()')
          if [ -z "$DEVICE_ID" ]; then
            echo "iPhone 15 not found, creating..."
            RUNTIME=$(xcrun simctl list runtimes | grep "iOS 17" | tail -1 | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+')
            xcrun simctl create "iPhone 15" "iPhone 15" "$RUNTIME"
            DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 (" | head -1 | grep -oE '\(([A-F0-9-]+)\)' | tr -d '()')
          fi
          echo "Booting simulator: $DEVICE_ID"
          xcrun simctl boot "$DEVICE_ID" || true
          xcrun simctl bootstatus "$DEVICE_ID" -b
        timeout-minutes: 5

      - name: üî® Build iOS app for testing
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          xcodebuild -workspace ios/iayosmobile.xcworkspace \
            -scheme iayosmobile \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath ios/build \
            -quiet \
            build
        timeout-minutes: 20

      - name: üß™ Run Detox E2E tests (iOS)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          npx detox test --configuration ios.sim.debug --headless --record-logs all --take-screenshots failing 2>&1 | tee e2e/reports/test-output.log || true
        timeout-minutes: 15
        id: detox_tests

      - name: üìä Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-test-report
          path: |
            apps/frontend_mobile/iayos_mobile/e2e/reports/
            apps/frontend_mobile/iayos_mobile/e2e/artifacts/
          retention-days: 14
          if-no-files-found: warn

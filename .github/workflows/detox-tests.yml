# Detox E2E Tests - Can use APK from GitHub Releases
#
# This workflow can test in two modes:
# 1. Use pre-built APK from GitHub release (RECOMMENDED - fast, reliable)
# 2. Build from source (requires expo-dev-client setup)
#
# See: apps/frontend_mobile/iayos_mobile/E2E_TESTING_QUICKSTART.md
#
name: Mobile E2E Tests (Detox)

on:
  # Manual trigger only - can test using APK from GitHub releases
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to test"
        required: true
        default: "android"
        type: choice
        options:
          - android
          - ios
          - both
      use_release_apk:
        description: "Use APK from latest GitHub release (recommended)"
        required: true
        default: true
        type: boolean
      use_live_backend:
        description: "Use live backend (api.iayos.online) instead of local staging"
        required: true
        default: true
        type: boolean
      release_tag:
        description: "Specific release tag (leave empty for latest)"
        required: false
        type: string

env:
  # Development builds connect to live backend (configured in eas.json)
  STAGING_BACKEND_URL: ${{ secrets.STAGING_BACKEND_URL || 'https://api.iayos.online' }}
  EXPO_PUBLIC_API_URL: ${{ secrets.STAGING_BACKEND_URL || 'https://api.iayos.online' }}

jobs:
  test-android:
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both'
    runs-on: ubuntu-latest
    timeout-minutes: 45 # Detox tests with Django backend

    services:
      postgres:
        image: ${{ github.event.inputs.use_live_backend != 'true' && 'postgres:15-alpine' || '' }}
        env:
          POSTGRES_DB: iayos_e2e_db
          POSTGRES_USER: iayos_user
          POSTGRES_PASSWORD: e2e_test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: ${{ github.event.inputs.use_live_backend != 'true' && 'redis:7-alpine' || '' }}
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: âš ï¸ Pre-flight Check - Build Source
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Test Configuration:"
          echo ""
          if [ "${{ github.event.inputs.use_release_apk }}" = "true" ]; then
            echo "âœ… APK Source: GitHub Release"
            echo "   Development builds include expo-dev-client for Detox support"
          else
            echo "âš ï¸  APK Source: Build from source"
            echo "   This will fail unless expo-dev-client is configured!"
          fi
          echo ""
          if [ "${{ github.event.inputs.use_live_backend }}" = "true" ]; then
            echo "ğŸŒ Backend: Live (api.iayos.online)"
            echo "   Tests will run against production backend"
            echo "   âš ï¸  Ensure test users exist in production!"
          else
            echo "ğŸ—ï¸ Backend: Local staging (localhost:8000)"
            echo "   Fresh database with test data will be created"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: ğŸ Setup Python
        if: github.event.inputs.use_live_backend != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: apps/backend/requirements.txt

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ğŸ“¦ Install backend dependencies
        if: github.event.inputs.use_live_backend != 'true'
        working-directory: apps/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”§ Apply Django Ninja UUID patch
        if: github.event.inputs.use_live_backend != 'true'
        run: |
          NINJA_PATH=$(pip show django-ninja | grep -i "^Location:" | cut -d' ' -f2)
          UTILS_FILE="$NINJA_PATH/ninja/signature/utils.py"
          echo "[PATCH] Looking for: $UTILS_FILE"
          if [ -f "$UTILS_FILE" ]; then
            if grep -q "except ValueError" "$UTILS_FILE"; then
              echo "[PATCH] Already patched"
            else
              sed -i 's/register_converter(NinjaUUIDConverter, "uuid")/try:\n    register_converter(NinjaUUIDConverter, "uuid")\nexcept ValueError:\n    pass/' "$UTILS_FILE"
              echo "[PATCH] Django Ninja UUID patch applied"
            fi
          else
            echo "[PATCH] Warning: File not found"
          fi

      - name: ğŸ—„ï¸ Run database migrations
        if: github.event.inputs.use_live_backend != 'true'
        working-directory: apps/backend/src
        env:
          USE_LOCAL_DB: "true"
          DATABASE_URL_LOCAL: postgresql://iayos_user:e2e_test_password@localhost:5432/iayos_e2e_db
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SECRET_KEY: e2e-test-secret-key
          DEBUG: "True"
          ALLOWED_HOSTS: localhost,127.0.0.1,0.0.0.0
        run: python manage.py migrate --noinput

      - name: ğŸ‘¤ Create test users
        if: github.event.inputs.use_live_backend != 'true'
        working-directory: apps/backend/src
        env:
          USE_LOCAL_DB: "true"
          DATABASE_URL_LOCAL: postgresql://iayos_user:e2e_test_password@localhost:5432/iayos_e2e_db
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SECRET_KEY: e2e-test-secret-key
        run: |
          python manage.py shell <<EOF
          from accounts.models import Accounts, Profile, WorkerProfile, ClientProfile
          from django.contrib.auth.hashers import make_password
          from datetime import date

          # Create test client
          client_account = Accounts.objects.create(
              email='client@test.com',
              password=make_password('Test123!'),
              isVerified=True
          )
          client_profile = Profile.objects.create(
              accountFK=client_account,
              profileType='CLIENT',
              firstName='Test',
              lastName='Client',
              contactNum='09123456789',
              birthDate=date(1990, 1, 1)
          )
          ClientProfile.objects.create(
              profileID=client_profile,
              description='Test client for E2E testing',
              totalJobsPosted=0
          )

          # Create test worker
          worker_account = Accounts.objects.create(
              email='worker@test.com',
              password=make_password('Test123!'),
              isVerified=True
          )
          worker_profile = Profile.objects.create(
              accountFK=worker_account,
              profileType='WORKER',
              firstName='Test',
              lastName='Worker',
              contactNum='09987654321',
              birthDate=date(1995, 6, 15)
          )
          WorkerProfile.objects.create(
              profileID=worker_profile,
              description='Test worker for E2E testing'
          )

          print('Test users created successfully')
          EOF

      - name: ğŸš€ Start Django backend server
        if: github.event.inputs.use_live_backend != 'true'
        working-directory: apps/backend/src
        env:
          USE_LOCAL_DB: "true"
          DATABASE_URL_LOCAL: postgresql://iayos_user:e2e_test_password@localhost:5432/iayos_e2e_db
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SECRET_KEY: e2e-test-secret-key
          DEBUG: "True"
          ALLOWED_HOSTS: localhost,127.0.0.1,0.0.0.0
        run: |
          echo "Starting Django backend on 0.0.0.0:8000..."
          python manage.py runserver 0.0.0.0:8000 > /tmp/backend.log 2>&1 &
          echo $! > /tmp/backend.pid
          echo "Backend PID: $(cat /tmp/backend.pid)"

          # Wait for backend to be ready
          echo "Waiting for Django backend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/api/health/ > /dev/null 2>&1 || curl -s http://localhost:8000/health/live > /dev/null 2>&1; then
              echo "âœ… Django backend is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âš ï¸ Backend health check failed, but continuing (Django may not have health endpoint)"
              echo "Backend log tail:"
              tail -20 /tmp/backend.log || true
            fi
            echo "  Attempt $i/30 - waiting..."
            sleep 2
          done

      - name: ğŸ“± Enable KVM (for Android Emulator)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: ğŸ“¦ Install dependencies
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Installing dependencies with legacy-peer-deps..."
          npm ci --legacy-peer-deps --prefer-offline || npm install --legacy-peer-deps
        timeout-minutes: 10

      - name: ğŸ“ Create artifact directories
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          mkdir -p e2e/reports
          mkdir -p e2e/artifacts
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/reports/.gitkeep.json
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/artifacts/.gitkeep.json

      - name: ğŸ”§ Generate native Android project (Expo Prebuild)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: npx expo prebuild --platform android --clean

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ“± Install Android System Image
        run: |
          echo "Installing Android 31 system image..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-31;google_apis;x86_64"
          echo "âœ… System image installed"

      - name: ğŸ”§ Create Android AVD
        run: |
          echo "=== AVD Creation Diagnostics ==="
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "HOME: $HOME"
          echo "ANDROID_AVD_HOME: ${ANDROID_AVD_HOME:-not set}"

          echo ""
          echo "Setting ANDROID_AVD_HOME to ensure emulator can find AVD..."
          export ANDROID_AVD_HOME=$HOME/.android/avd
          mkdir -p $ANDROID_AVD_HOME
          echo "ANDROID_AVD_HOME set to: $ANDROID_AVD_HOME"

          echo ""
          echo "Creating AVD without device profile (generic)..."
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n test_avd \
            -k "system-images;android-31;google_apis;x86_64" \
            --force

          echo ""
          echo "Listing created AVDs..."
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd

          echo ""
          echo "Checking AVD files..."
          ls -la $HOME/.android/avd/ || echo "Directory does not exist"

          echo ""
          echo "âœ… AVD created successfully"

      - name: ğŸš€ Start Android Emulator
        run: |
          echo "=== Emulator startup diagnostics ==="
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "HOME: $HOME"

          echo "Setting ANDROID_AVD_HOME for emulator..."
          export ANDROID_AVD_HOME=$HOME/.android/avd
          echo "ANDROID_AVD_HOME: $ANDROID_AVD_HOME"

          echo ""
          echo "Listing available AVDs before starting..."
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd || echo "Failed to list AVDs"

          echo ""
          echo "ADB version:"
          adb version
          echo "Emulator location: $ANDROID_HOME/emulator/emulator"
          ls -la $ANDROID_HOME/emulator/emulator

          echo ""
          echo "Starting adb server explicitly..."
          adb start-server
          sleep 2
          adb devices

          echo ""
          echo "Starting emulator with verbose logging..."
          nohup $ANDROID_HOME/emulator/emulator -avd test_avd \
            -no-snapshot-save \
            -no-window \
            -gpu swiftshader_indirect \
            -noaudio \
            -no-boot-anim \
            -camera-back none \
            -camera-front none \
            -memory 2048 \
            -partition-size 2048 \
            -verbose \
            -qemu -enable-kvm > /tmp/emulator.log 2>&1 &

          EMULATOR_PID=$!
          echo "Emulator started with PID: $EMULATOR_PID"

          echo ""
          echo "Waiting for emulator device to appear (max 2 minutes)..."
          DEVICE_FOUND=false
          for i in {1..24}; do
            ADB_DEVICES=$(adb devices | grep -v "List of devices" | grep "emulator" || echo "")
            if [ -n "$ADB_DEVICES" ]; then
              DEVICE_FOUND=true
              echo "âœ… Device appeared after ~$((i*5)) seconds"
              echo "Devices: $ADB_DEVICES"
              break
            fi
            echo "Attempt $i/24: No device yet..."
            if [ $i -eq 12 ]; then
              echo "=== Checking emulator process ==="
              ps aux | grep emulator | grep -v grep || echo "Emulator process not found!"
              echo "=== First 50 lines of emulator log ==="
              head -50 /tmp/emulator.log || true
            fi
            sleep 5
          done

          if [ "$DEVICE_FOUND" = "false" ]; then
            echo ""
            echo "âŒ Emulator device never appeared in adb devices"
            echo "=== Full emulator log ==="
            cat /tmp/emulator.log || true
            echo ""
            echo "=== Emulator process check ==="
            ps aux | grep emulator | grep -v grep || echo "Process not running"
            exit 1
          fi

          echo ""
          echo "Waiting for device to be online..."
          adb wait-for-device

          echo ""
          echo "Waiting for boot to complete (max 5 minutes)..."
          BOOT_COMPLETED=false
          for i in {1..60}; do
            BOOT_STATUS=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
            if [ "$BOOT_STATUS" = "1" ]; then
              BOOT_COMPLETED=true
              echo "âœ… Boot completed after ~$((i*5)) seconds"
              break
            fi
            if [ $((i % 6)) -eq 0 ]; then
              echo "Still waiting... attempt $i/60 (boot_completed='$BOOT_STATUS')"
            fi
            sleep 5
          done

          if [ "$BOOT_COMPLETED" = "false" ]; then
            echo ""
            echo "âŒ Emulator failed to boot within timeout"
            echo "=== Device properties ==="
            adb shell getprop || true
            echo ""
            echo "=== Emulator log ==="
            cat /tmp/emulator.log || true
            exit 1
          fi

          echo ""
          echo "Unlocking screen..."
          adb shell input keyevent 82

          echo "Disabling animations for faster tests..."
          adb shell settings put global window_animation_scale 0
          adb shell settings put global transition_animation_scale 0
          adb shell settings put global animator_duration_scale 0

          echo ""
          echo "âœ… Emulator fully ready"
          adb devices -l

      - name: ğŸ“¦ Download APK from GitHub Release
        if: github.event.inputs.use_release_apk == 'true'
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "ğŸ“¦ Downloading APK from GitHub Release..."

          # Determine which release to use
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
            echo "Using specified release: $RELEASE_TAG"
          else
            echo "Fetching latest release..."
            RELEASE_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
            echo "Latest release: $RELEASE_TAG"
          fi

          # Create output directory
          mkdir -p android/app/build/outputs/apk/debug
          mkdir -p android/app/build/outputs/apk/androidTest/debug

          # Download APK from release
          echo "Downloading APK assets from release $RELEASE_TAG..."

          # Try common APK naming patterns
          APK_DOWNLOADED=false

          # Pattern 1: app-debug.apk
          if gh release download "$RELEASE_TAG" -p "app-debug.apk" -D android/app/build/outputs/apk/debug/ 2>/dev/null; then
            echo "âœ… Downloaded app-debug.apk"
            APK_DOWNLOADED=true
          # Pattern 2: *-debug.apk
          elif gh release download "$RELEASE_TAG" -p "*-debug.apk" -D android/app/build/outputs/apk/debug/ 2>/dev/null; then
            # Rename to standard name
            mv android/app/build/outputs/apk/debug/*-debug.apk android/app/build/outputs/apk/debug/app-debug.apk
            echo "âœ… Downloaded and renamed debug APK"
            APK_DOWNLOADED=true
          # Pattern 3: *.apk (any APK)
          elif gh release download "$RELEASE_TAG" -p "*.apk" -D android/app/build/outputs/apk/debug/ 2>/dev/null; then
            # Use the first APK found
            FIRST_APK=$(ls android/app/build/outputs/apk/debug/*.apk | head -1)
            if [ -n "$FIRST_APK" ]; then
              mv "$FIRST_APK" android/app/build/outputs/apk/debug/app-debug.apk
              echo "âœ… Downloaded and renamed: $(basename $FIRST_APK)"
              APK_DOWNLOADED=true
            fi
          fi

          if [ "$APK_DOWNLOADED" = "false" ]; then
            echo "âŒ No APK found in release $RELEASE_TAG"
            echo "Available assets in release:"
            gh release view "$RELEASE_TAG" --json assets --jq '.assets[].name'
            exit 1
          fi

          # Verify APK
          APK_PATH="android/app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK_PATH" ]; then
            echo "âœ… APK ready at: $APK_PATH"
            echo "APK size: $(du -h $APK_PATH | cut -f1)"
          else
            echo "âŒ APK not found after download"
            exit 1
          fi

          # Note: We still need to build the androidTest APK for Detox
          echo ""
          echo "âš ï¸  Note: Still need to build androidTest APK for Detox instrumentation"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: ğŸ—ï¸ Build Android Test APK
        if: github.event.inputs.use_release_apk == 'true'
        working-directory: apps/frontend_mobile/iayos_mobile/android
        run: |
          echo "Building androidTest APK for Detox instrumentation..."
          export GRADLE_OPTS="-Xmx4g -Xms512m -XX:MaxMetaspaceSize=1g"

          ./gradlew :app:assembleDebugAndroidTest \
            -DtestBuildType=debug \
            -PreactNativeArchitectures=x86_64 \
            --no-daemon \
            --max-workers=2 \
            -x lint

          echo "âœ… Test APK built"
          ls -lh app/build/outputs/apk/androidTest/debug/
        timeout-minutes: 15

      - name: ğŸ—ï¸ Build Android app for testing
        if: github.event.inputs.use_release_apk != 'true'
        working-directory: apps/frontend_mobile/iayos_mobile
        env:
          # CRITICAL: These must be exported for Metro bundler to embed in JS bundle
          EXPO_PUBLIC_API_URL: ${{ secrets.STAGING_BACKEND_URL || 'http://10.0.2.2:8000' }}
          EXPO_PUBLIC_E2E_MODE: "true"
        run: |
          # Export env vars for all subprocesses
          export EXPO_PUBLIC_API_URL="${EXPO_PUBLIC_API_URL}"
          export EXPO_PUBLIC_E2E_MODE="true"

          echo "=== E2E Build Configuration ==="
          echo "EXPO_PUBLIC_API_URL: ${EXPO_PUBLIC_API_URL}"
          echo "EXPO_PUBLIC_E2E_MODE: ${EXPO_PUBLIC_E2E_MODE}"
          echo "Note: E2E mode skips auth check so app becomes ready immediately"
          echo ""

          # Clear ALL caches to ensure fresh JS bundle with E2E mode enabled
          echo "Clearing Metro bundler and build caches..."
          rm -rf node_modules/.cache 2>/dev/null || true
          rm -rf /tmp/metro-* 2>/dev/null || true
          rm -rf /tmp/haste-map-* 2>/dev/null || true
          rm -rf android/.gradle 2>/dev/null || true
          rm -rf android/app/build 2>/dev/null || true

          # Verify AuthContext has E2E mode code
          echo ""
          echo "Verifying AuthContext.tsx has E2E mode code..."
          echo "Current directory: $(pwd)"
          echo "Looking for context/AuthContext.tsx..."
          ls -la context/ 2>/dev/null || echo "context/ directory not found"

          if [ -f "context/AuthContext.tsx" ] && grep -q "EXPO_PUBLIC_E2E_MODE" context/AuthContext.tsx; then
            echo "âœ… E2E mode code is present in AuthContext.tsx"
            grep -n "E2E" context/AuthContext.tsx | head -5
          else
            echo "âŒ WARNING: E2E mode code NOT found in AuthContext.tsx!"
            echo "App may hang waiting for auth check."
            echo "File exists check:"
            ls -la context/AuthContext.tsx 2>/dev/null || echo "File not found"
          fi
          echo ""

          cd android

          export GRADLE_OPTS="-Xmx4g -Xms512m -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"

          # Full clean build
          echo "Cleaning previous build artifacts..."
          ./gradlew clean --no-daemon

          echo "Building for x86_64 ONLY (emulator architecture)..."
          echo "This reduces native build time by ~75% (1 arch instead of 4)"

          ./gradlew :app:assembleDebug :app:assembleDebugAndroidTest \
            -DtestBuildType=debug \
            -PreactNativeArchitectures=x86_64 \
            --no-daemon \
            --max-workers=2 \
            --parallel \
            -x lint \
            -x lintVitalAnalyzeRelease \
            -x lintVitalReportRelease \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=1g" \
            || {
              echo "âŒ Build failed, retrying with --stacktrace..."
              ./gradlew :app:assembleDebug :app:assembleDebugAndroidTest \
                -DtestBuildType=debug \
                -PreactNativeArchitectures=x86_64 \
                --no-daemon \
                --stacktrace \
                --max-workers=1 \
                -x lint
            }
        timeout-minutes: 20

      - name: âœ… Verify E2E mode in APK bundle
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Verifying E2E mode code is embedded in the APK..."
          APK_PATH="android/app/build/outputs/apk/debug/app-debug.apk"

          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found at $APK_PATH"
            exit 1
          fi

          echo "APK size: $(du -h $APK_PATH | cut -f1)"

          # Extract and check the JS bundle
          echo ""
          echo "Extracting JS bundle from APK..."
          unzip -p "$APK_PATH" assets/index.android.bundle > /tmp/bundle.js 2>/dev/null || true

          if [ -f /tmp/bundle.js ]; then
            BUNDLE_SIZE=$(wc -c < /tmp/bundle.js)
            echo "JS bundle size: $BUNDLE_SIZE bytes"
            
            # Check for E2E mode code
            if grep -q "EXPO_PUBLIC_E2E_MODE" /tmp/bundle.js; then
              echo "âœ… EXPO_PUBLIC_E2E_MODE found in JS bundle"
            else
              echo "âš ï¸ EXPO_PUBLIC_E2E_MODE not found in bundle (may be minified)"
            fi
            
            # Check for E2E mode string
            if grep -q "E2E Mode" /tmp/bundle.js || grep -q "E2E_MODE" /tmp/bundle.js; then
              echo "âœ… E2E mode strings found in JS bundle"
            else
              echo "âš ï¸ E2E mode strings not visible (normal for minified code)"
            fi
            
            # Check for auth timeout code
            if grep -q "AUTH_TIMEOUT" /tmp/bundle.js || grep -q "auth.*timeout" /tmp/bundle.js; then
              echo "âœ… Auth timeout code found in JS bundle"
            else
              echo "âš ï¸ Auth timeout strings not visible (normal for minified code)"
            fi
            
            rm /tmp/bundle.js
          else
            echo "âš ï¸ Could not extract JS bundle (may be in different location)"
          fi

          echo ""
          echo "APK verification complete"

      - name: ğŸ”Œ Setup ADB port forwarding for backend
        run: |
          echo "Setting up ADB reverse port forwarding..."
          echo "This allows the Android emulator to reach host services via localhost"

          # Port 8000: Backend API
          adb reverse tcp:8000 tcp:8000
          echo "âœ… Forwarded tcp:8000 (Backend API)"

          # Port 8081: Metro bundler (usually set by Detox, but let's ensure it)
          adb reverse tcp:8081 tcp:8081
          echo "âœ… Forwarded tcp:8081 (Metro bundler)"

          # Verify the reverse forwarding is active
          echo ""
          echo "Active ADB reverse ports:"
          adb reverse --list

          # Test backend connectivity from host
          echo ""
          echo "Testing backend connectivity from host..."
          curl -s http://localhost:8000/health/live && echo " - Backend health check passed" || echo " - No /health/live endpoint (may be normal)"

      - name: ğŸ§ª Run Detox E2E Tests
        id: detox_tests
        working-directory: apps/frontend_mobile/iayos_mobile
        continue-on-error: true
        run: |
          echo "Installing Detox CLI..."
          npm install -g detox-cli

          # Create reports directory
          mkdir -p e2e/reports

          echo "Running Detox tests on emulator with JSON output..."
          # Use Jest's built-in --json flag instead of jest-json-reporter
          detox test \
            --configuration android.emu.debug \
            --headless \
            --record-logs all \
            --take-screenshots all \
            --record-videos failing \
            --loglevel verbose \
            -- --json --outputFile=e2e/reports/jest-test-results.json
        timeout-minutes: 15

      - name: ï¿½ Capture Android Logcat
        if: always()
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Capturing full Android logcat for debugging..."
          mkdir -p e2e/artifacts

          # Capture full logcat
          adb logcat -d > e2e/artifacts/full-logcat.txt 2>&1 || true

          # Extract React Native specific logs
          echo ""
          echo "=== React Native App Logs ==="
          grep -E "ReactNative|E2E|Auth|iayos|expo" e2e/artifacts/full-logcat.txt | tail -100 || echo "No RN logs found"

          # Check for crashes
          echo ""
          echo "=== Crash/Error Logs ==="
          grep -E "FATAL|crash|Exception|Error" e2e/artifacts/full-logcat.txt | tail -50 || echo "No crash logs found"

          # Check for network errors
          echo ""
          echo "=== Network Logs ==="
          grep -E "http|localhost|8000|network|connect" e2e/artifacts/full-logcat.txt | tail -30 || echo "No network logs found"

          echo ""
          echo "Full logcat saved to e2e/artifacts/full-logcat.txt"
          echo "Logcat size: $(wc -l < e2e/artifacts/full-logcat.txt) lines"

      - name: ï¿½ğŸ” Debug - Check test results file
        if: always()
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Checking for test results file..."
          if [ -f "e2e/reports/jest-test-results.json" ]; then
            echo "âœ… Test results file exists"
            echo "File size: $(wc -c < e2e/reports/jest-test-results.json) bytes"
            echo "First 500 characters:"
            head -c 500 e2e/reports/jest-test-results.json
            echo ""
          else
            echo "âŒ Test results file not found"
            echo "Contents of e2e/reports directory:"
            ls -la e2e/reports/ || echo "Directory doesn't exist"
          fi

      - name: ğŸ› Create GitHub Issues for Test Failures
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Parse Jest test results (Detox uses Jest)
            let testResults;
            try {
              const resultsPath = 'apps/frontend_mobile/iayos_mobile/e2e/reports/jest-test-results.json';
              if (!fs.existsSync(resultsPath)) {
                console.log('â„¹ï¸  No test results file found - tests may not have run or workflow failed');
                console.log('   Not creating issues for workflow/infrastructure failures');
                return;
              }
              testResults = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            } catch (error) {
              console.log('â„¹ï¸  Could not read test results:', error.message);
              console.log('   Not creating issues for workflow/infrastructure failures');
              return;
            }

            // Extract failed tests
            const failedTests = [];
            testResults.testResults?.forEach(testFile => {
              testFile.assertionResults?.forEach(test => {
                if (test.status === 'failed') {
                  failedTests.push({
                    testFile: testFile.name,
                    testName: test.fullName || test.title,
                    error: test.failureMessages?.join('\n') || 'No error message',
                    duration: test.duration
                  });
                }
              });
            });

            if (failedTests.length === 0) {
              console.log('âœ… No failed tests found in results (tests may have passed on retry)');
              return;
            }

            console.log(`Found ${failedTests.length} failed test(s)`);

            // Get existing issues to avoid duplicates
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2e-test,automated',
              per_page: 100
            });

            // Create issues for each failed test (limit to 10 to avoid spam)
            const maxIssues = Math.min(failedTests.length, 10);
            let createdCount = 0;

            for (let i = 0; i < maxIssues; i++) {
              const test = failedTests[i];
              const issueTitle = `ğŸ”´ E2E Test Failed: ${test.testName}`;

              // Check if issue already exists
              const isDuplicate = existingIssues.data.some(issue =>
                issue.title === issueTitle
              );

              if (isDuplicate) {
                console.log(`â­ï¸  Skipping duplicate issue: ${issueTitle}`);
                continue;
              }

              // Format error message
              const errorLines = test.error.split('\n');
              const errorPreview = errorLines.slice(0, 50).join('\n');
              const isTruncated = errorLines.length > 50;

              const issueBody = `## Test Failure Details

            **Test File:** \`${test.testFile}\`
            **Test Name:** ${test.testName}
            **Duration:** ${test.duration}ms

            ### Error Message

            \`\`\`
            ${errorPreview}${isTruncated ? '\n\n... (truncated, see workflow logs for full error)' : ''}
            \`\`\`

            ### Test Run Information

            - **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **Platform:** Android (x86_64 emulator)
            - **Configuration:** android.emu.debug
            - **Triggered by:** @${context.actor}
            - **Branch:** ${context.ref.replace('refs/heads/', '')}
            - **Commit:** ${context.sha.substring(0, 7)}

            ### Artifacts

            Check the workflow run for:
            - ğŸ“¸ Screenshots
            - ğŸ“ Test logs
            - ğŸ“¹ Videos (if available)

            ### Next Steps

            1. Review the error message and stack trace
            2. Check if this is a flaky test (search for previous occurrences)
            3. Reproduce locally: \`npm run test:e2e:android\`
            4. Fix the test or the underlying code
            5. Close this issue once resolved

            ---

            **Auto-generated by Mobile E2E Tests workflow**`;

              try {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['bug', 'e2e-test', 'automated', 'mobile', 'android']
                });
                createdCount++;
                console.log(`âœ… Created issue: ${issueTitle}`);
              } catch (error) {
                console.error(`âŒ Failed to create issue for ${test.testName}:`, error.message);
              }
            }

            if (failedTests.length > maxIssues) {
              console.log(`âš ï¸  Only created ${maxIssues} issues out of ${failedTests.length} failures to avoid spam`);
            }

            console.log(`ğŸ“Š Summary: Created ${createdCount} new issue(s) for failed tests`);

      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-test-report
          path: |
            apps/frontend_mobile/iayos_mobile/e2e/reports/
            apps/frontend_mobile/iayos_mobile/e2e/artifacts/
          retention-days: 14
          if-no-files-found: warn

      - name: ğŸ§¹ Cleanup test data from live backend
        if: always() && github.event.inputs.use_live_backend == 'true'
        continue-on-error: true
        run: |
          echo "ğŸ—‘ï¸ Cleaning up test data from live backend..."
          echo "âš ï¸  WARNING: This deletes test user accounts and associated data!"
          
          # Call backend cleanup API endpoint (you'll need to create this)
          # For now, we'll document what needs to be cleaned up
          
          cat << 'EOF'
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          âš ï¸  CLEANUP REQUIRED
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          The following test data needs to be cleaned from your live backend:
          
          Test Users:
            - client@test.com (CLIENT profile)
            - worker@test.com (WORKER profile)
          
          Associated Data:
            - Jobs posted by client@test.com
            - Profiles, applications, messages, notifications
            - Any data created during E2E tests
          
          RECOMMENDED SOLUTION:
          Create a Django management command to clean up test data:
          
            python manage.py cleanup_e2e_test_data
          
          Or create a backend API endpoint:
          
            POST /api/admin/cleanup-e2e-tests
            Authorization: Bearer <admin-token>
          
          For now, you may need to manually delete these test accounts
          from your production database to prevent bloat.
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          EOF

      - name: ğŸ§¹ Stop backend server
        if: always() && github.event.inputs.use_live_backend != 'true'
        run: |
          if [ -f /tmp/backend.pid ]; then
            echo "Stopping backend server..."
            kill $(cat /tmp/backend.pid) || true
            rm /tmp/backend.pid
          else
            echo "No backend PID file found (may not have started or using live backend)"
          fi

  test-ios:
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'
    runs-on: macos-14
    timeout-minutes: 45

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: apps/backend/requirements.txt

      - name: ğŸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: ğŸ—„ï¸ Install PostgreSQL and Redis
        run: |
          brew install postgresql@15 redis
          brew services start postgresql@15
          brew services start redis

      - name: ğŸ—„ï¸ Create test database
        run: |
          sleep 5  # Wait for PostgreSQL to start
          createdb iayos_e2e_db || true
          psql -d iayos_e2e_db -c "CREATE USER iayos_user WITH PASSWORD 'e2e_test_password';" || true
          psql -d iayos_e2e_db -c "GRANT ALL PRIVILEGES ON DATABASE iayos_e2e_db TO iayos_user;" || true
          psql -d iayos_e2e_db -c "ALTER DATABASE iayos_e2e_db OWNER TO iayos_user;" || true

      - name: ğŸ“¦ Install backend dependencies
        working-directory: apps/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”§ Apply Django Ninja UUID patch
        run: |
          NINJA_PATH=$(pip show django-ninja | grep -i "^Location:" | cut -d' ' -f2)
          UTILS_FILE="$NINJA_PATH/ninja/signature/utils.py"
          echo "[PATCH] Looking for: $UTILS_FILE"
          if [ -f "$UTILS_FILE" ]; then
            if grep -q "except ValueError" "$UTILS_FILE"; then
              echo "[PATCH] Already patched"
            else
              sed -i '' 's/register_converter(NinjaUUIDConverter, "uuid")/try:\n    register_converter(NinjaUUIDConverter, "uuid")\nexcept ValueError:\n    pass/' "$UTILS_FILE"
              echo "[PATCH] Django Ninja UUID patch applied"
            fi
          else
            echo "[PATCH] Warning: File not found"
          fi

      - name: ğŸ—„ï¸ Run database migrations
        working-directory: apps/backend/src
        env:
          USE_LOCAL_DB: "true"
          DATABASE_URL_LOCAL: postgresql://iayos_user:e2e_test_password@localhost:5432/iayos_e2e_db
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SECRET_KEY: e2e-test-secret-key
          DEBUG: "True"
          ALLOWED_HOSTS: localhost,127.0.0.1
        run: python manage.py migrate --noinput

      - name: ğŸ‘¥ Create test users
        working-directory: apps/backend/src
        env:
          USE_LOCAL_DB: "true"
          DATABASE_URL_LOCAL: postgresql://iayos_user:e2e_test_password@localhost:5432/iayos_e2e_db
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SECRET_KEY: e2e-test-secret-key
        run: |
          python manage.py shell <<EOF
          from accounts.models import Accounts, Profile, WorkerProfile, ClientProfile
          from django.contrib.auth.hashers import make_password
          from datetime import date

          # Create test client
          client_account = Accounts.objects.create(
              email='client@test.com',
              password=make_password('Test123!'),
              isVerified=True
          )
          client_profile = Profile.objects.create(
              accountFK=client_account,
              profileType='CLIENT',
              firstName='Test',
              lastName='Client',
              contactNum='09123456789',
              birthDate=date(1990, 1, 1)
          )
          ClientProfile.objects.create(
              profileID=client_profile,
              description='Test client for E2E testing',
              totalJobsPosted=0
          )

          # Create test worker
          worker_account = Accounts.objects.create(
              email='worker@test.com',
              password=make_password('Test123!'),
              isVerified=True
          )
          worker_profile = Profile.objects.create(
              accountFK=worker_account,
              profileType='WORKER',
              firstName='Test',
              lastName='Worker',
              contactNum='09987654321',
              birthDate=date(1995, 6, 15)
          )
          WorkerProfile.objects.create(
              profileID=worker_profile,
              description='Test worker for E2E testing'
          )

          print('Test users created successfully')
          EOF

      - name: ğŸš€ Start backend server
        working-directory: apps/backend/src
        env:
          USE_LOCAL_DB: "true"
          DATABASE_URL_LOCAL: postgresql://iayos_user:e2e_test_password@localhost:5432/iayos_e2e_db
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SECRET_KEY: e2e-test-secret-key
          DEBUG: "True"
          ALLOWED_HOSTS: localhost,127.0.0.1
        run: |
          python manage.py runserver 8000 &
          echo $! > backend.pid
          sleep 5

      - name: ğŸ“¦ Install dependencies
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Installing dependencies with legacy-peer-deps..."
          npm ci --legacy-peer-deps --prefer-offline || npm install --legacy-peer-deps
        timeout-minutes: 10

      - name: ğŸ“ Create artifact directories
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          mkdir -p e2e/reports
          mkdir -p e2e/artifacts
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/reports/.gitkeep.json
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/artifacts/.gitkeep.json

      - name: ğŸ”§ Generate native iOS project (Expo Prebuild)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: npx expo prebuild --platform ios --clean

      - name: ğŸ“± Install CocoaPods dependencies
        working-directory: apps/frontend_mobile/iayos_mobile/ios
        run: pod install

      - name: ğŸº Install Detox CLI tools
        run: brew tap wix/brew && brew install applesimutils

      - name: ğŸ“± Boot iPhone 15 Simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 (" | head -1 | grep -oE '\(([A-F0-9-]+)\)' | tr -d '()')
          if [ -z "$DEVICE_ID" ]; then
            echo "iPhone 15 not found, creating..."
            RUNTIME=$(xcrun simctl list runtimes | grep "iOS 17" | tail -1 | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+')
            xcrun simctl create "iPhone 15" "iPhone 15" "$RUNTIME"
            DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 (" | head -1 | grep -oE '\(([A-F0-9-]+)\)' | tr -d '()')
          fi
          echo "Booting simulator: $DEVICE_ID"
          xcrun simctl boot "$DEVICE_ID" || true
          xcrun simctl bootstatus "$DEVICE_ID" -b
        timeout-minutes: 5

      - name: ğŸ”¨ Build iOS app for testing
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          xcodebuild -workspace ios/iayosmobile.xcworkspace \
            -scheme iayosmobile \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath ios/build \
            -quiet \
            build
        timeout-minutes: 20

      - name: ğŸ§ª Run Detox E2E tests (iOS)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          npx detox test --configuration ios.sim.debug --headless --record-logs all --take-screenshots failing 2>&1 | tee e2e/reports/test-output.log || true
        timeout-minutes: 15
        id: detox_tests

      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-test-report
          path: |
            apps/frontend_mobile/iayos_mobile/e2e/reports/
            apps/frontend_mobile/iayos_mobile/e2e/artifacts/
          retention-days: 14
          if-no-files-found: warn

      - name: ğŸ§¹ Stop backend server and services
        if: always()
        run: |
          if [ -f apps/backend/src/backend.pid ]; then
            kill $(cat apps/backend/src/backend.pid) || true
            rm apps/backend/src/backend.pid
          fi
          brew services stop postgresql@15 || true
          brew services stop redis || true

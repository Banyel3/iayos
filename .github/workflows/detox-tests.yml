name: Mobile E2E Tests

on:
  # Manual trigger - stable for Android, iOS still experimental
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to test"
        required: true
        default: "android"
        type: choice
        options:
          - android
          - ios
          - both

env:
  STAGING_BACKEND_URL: ${{ secrets.STAGING_BACKEND_URL || 'http://localhost:8000' }}
  EXPO_PUBLIC_API_URL: ${{ secrets.STAGING_BACKEND_URL || 'http://localhost:8000' }}

jobs:
  test-android:
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ðŸ“± Enable KVM (for Android Emulator)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: ðŸ“¦ Install dependencies
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Installing dependencies with legacy-peer-deps..."
          npm ci --legacy-peer-deps --prefer-offline || npm install --legacy-peer-deps
        timeout-minutes: 10

      - name: ðŸ“ Create artifact directories
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          mkdir -p e2e/reports
          mkdir -p e2e/artifacts
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/reports/.gitkeep.json
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/artifacts/.gitkeep.json

      - name: ðŸ”§ Generate native Android project (Expo Prebuild)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: npx expo prebuild --platform android --clean

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“± Install Android System Image
        run: |
          echo "Installing Android 31 system image..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-31;google_apis;x86_64"
          echo "âœ… System image installed"

      - name: ðŸ”§ Create Android AVD
        run: |
          echo "=== AVD Creation Diagnostics ==="
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "HOME: $HOME"
          echo "ANDROID_AVD_HOME: ${ANDROID_AVD_HOME:-not set}"

          echo ""
          echo "Setting ANDROID_AVD_HOME to ensure emulator can find AVD..."
          export ANDROID_AVD_HOME=$HOME/.android/avd
          mkdir -p $ANDROID_AVD_HOME
          echo "ANDROID_AVD_HOME set to: $ANDROID_AVD_HOME"

          echo ""
          echo "Creating AVD without device profile (generic)..."
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n test_avd \
            -k "system-images;android-31;google_apis;x86_64" \
            --force

          echo ""
          echo "Listing created AVDs..."
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd

          echo ""
          echo "Checking AVD files..."
          ls -la $HOME/.android/avd/ || echo "Directory does not exist"

          echo ""
          echo "âœ… AVD created successfully"

      - name: ðŸš€ Start Android Emulator
        run: |
          echo "=== Emulator startup diagnostics ==="
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "HOME: $HOME"

          echo "Setting ANDROID_AVD_HOME for emulator..."
          export ANDROID_AVD_HOME=$HOME/.android/avd
          echo "ANDROID_AVD_HOME: $ANDROID_AVD_HOME"

          echo ""
          echo "Listing available AVDs before starting..."
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd || echo "Failed to list AVDs"

          echo ""
          echo "ADB version:"
          adb version
          echo "Emulator location: $ANDROID_HOME/emulator/emulator"
          ls -la $ANDROID_HOME/emulator/emulator

          echo ""
          echo "Starting adb server explicitly..."
          adb start-server
          sleep 2
          adb devices

          echo ""
          echo "Starting emulator with verbose logging..."
          nohup $ANDROID_HOME/emulator/emulator -avd test_avd \
            -no-snapshot-save \
            -no-window \
            -gpu swiftshader_indirect \
            -noaudio \
            -no-boot-anim \
            -camera-back none \
            -camera-front none \
            -memory 2048 \
            -partition-size 2048 \
            -verbose \
            -qemu -enable-kvm > /tmp/emulator.log 2>&1 &

          EMULATOR_PID=$!
          echo "Emulator started with PID: $EMULATOR_PID"

          echo ""
          echo "Waiting for emulator device to appear (max 2 minutes)..."
          DEVICE_FOUND=false
          for i in {1..24}; do
            ADB_DEVICES=$(adb devices | grep -v "List of devices" | grep "emulator" || echo "")
            if [ -n "$ADB_DEVICES" ]; then
              DEVICE_FOUND=true
              echo "âœ… Device appeared after ~$((i*5)) seconds"
              echo "Devices: $ADB_DEVICES"
              break
            fi
            echo "Attempt $i/24: No device yet..."
            if [ $i -eq 12 ]; then
              echo "=== Checking emulator process ==="
              ps aux | grep emulator | grep -v grep || echo "Emulator process not found!"
              echo "=== First 50 lines of emulator log ==="
              head -50 /tmp/emulator.log || true
            fi
            sleep 5
          done

          if [ "$DEVICE_FOUND" = "false" ]; then
            echo ""
            echo "âŒ Emulator device never appeared in adb devices"
            echo "=== Full emulator log ==="
            cat /tmp/emulator.log || true
            echo ""
            echo "=== Emulator process check ==="
            ps aux | grep emulator | grep -v grep || echo "Process not running"
            exit 1
          fi

          echo ""
          echo "Waiting for device to be online..."
          adb wait-for-device

          echo ""
          echo "Waiting for boot to complete (max 5 minutes)..."
          BOOT_COMPLETED=false
          for i in {1..60}; do
            BOOT_STATUS=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
            if [ "$BOOT_STATUS" = "1" ]; then
              BOOT_COMPLETED=true
              echo "âœ… Boot completed after ~$((i*5)) seconds"
              break
            fi
            if [ $((i % 6)) -eq 0 ]; then
              echo "Still waiting... attempt $i/60 (boot_completed='$BOOT_STATUS')"
            fi
            sleep 5
          done

          if [ "$BOOT_COMPLETED" = "false" ]; then
            echo ""
            echo "âŒ Emulator failed to boot within timeout"
            echo "=== Device properties ==="
            adb shell getprop || true
            echo ""
            echo "=== Emulator log ==="
            cat /tmp/emulator.log || true
            exit 1
          fi

          echo ""
          echo "Unlocking screen..."
          adb shell input keyevent 82

          echo "Disabling animations for faster tests..."
          adb shell settings put global window_animation_scale 0
          adb shell settings put global transition_animation_scale 0
          adb shell settings put global animator_duration_scale 0

          echo ""
          echo "âœ… Emulator fully ready"
          adb devices -l

      - name: ðŸ—ï¸ Build Android app for testing
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          cd android

          echo "Configuring Gradle for CI build..."
          export GRADLE_OPTS="-Xmx4g -Xms512m -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"

          echo "Building only main app debug and test APKs (skipping dependency test APKs)..."
          ./gradlew :app:assembleDebug :app:assembleDebugAndroidTest \
            -DtestBuildType=debug \
            --no-daemon \
            --max-workers=2 \
            --parallel \
            -x lint \
            -x lintVitalAnalyzeRelease \
            -x lintVitalReportRelease \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=1g" \
            || {
              echo "âŒ Build failed, retrying with --stacktrace..."
              ./gradlew :app:assembleDebug :app:assembleDebugAndroidTest \
                -DtestBuildType=debug \
                --no-daemon \
                --stacktrace \
                --max-workers=1 \
                -x lint
            }
        timeout-minutes: 15
      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-test-report
          path: |
            apps/frontend_mobile/iayos_mobile/e2e/reports/
            apps/frontend_mobile/iayos_mobile/e2e/artifacts/
          retention-days: 14
          if-no-files-found: warn

  test-ios:
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'
    runs-on: macos-14
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: ðŸŽ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: ðŸ“¦ Install dependencies
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          echo "Installing dependencies with legacy-peer-deps..."
          npm ci --legacy-peer-deps --prefer-offline || npm install --legacy-peer-deps
        timeout-minutes: 10

      - name: ðŸ“ Create artifact directories
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          mkdir -p e2e/reports
          mkdir -p e2e/artifacts
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/reports/.gitkeep.json
          echo '{"created": "'$(date -Iseconds)'"}' > e2e/artifacts/.gitkeep.json

      - name: ðŸ”§ Generate native iOS project (Expo Prebuild)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: npx expo prebuild --platform ios --clean

      - name: ðŸ“± Install CocoaPods dependencies
        working-directory: apps/frontend_mobile/iayos_mobile/ios
        run: pod install

      - name: ðŸº Install Detox CLI tools
        run: brew tap wix/brew && brew install applesimutils

      - name: ðŸ“± Boot iPhone 15 Simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 (" | head -1 | grep -oE '\(([A-F0-9-]+)\)' | tr -d '()')
          if [ -z "$DEVICE_ID" ]; then
            echo "iPhone 15 not found, creating..."
            RUNTIME=$(xcrun simctl list runtimes | grep "iOS 17" | tail -1 | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+')
            xcrun simctl create "iPhone 15" "iPhone 15" "$RUNTIME"
            DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 (" | head -1 | grep -oE '\(([A-F0-9-]+)\)' | tr -d '()')
          fi
          echo "Booting simulator: $DEVICE_ID"
          xcrun simctl boot "$DEVICE_ID" || true
          xcrun simctl bootstatus "$DEVICE_ID" -b
        timeout-minutes: 5

      - name: ðŸ”¨ Build iOS app for testing
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          xcodebuild -workspace ios/iayosmobile.xcworkspace \
            -scheme iayosmobile \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath ios/build \
            -quiet \
            build
        timeout-minutes: 20

      - name: ðŸ§ª Run Detox E2E tests (iOS)
        working-directory: apps/frontend_mobile/iayos_mobile
        run: |
          npx detox test --configuration ios.sim.debug --headless --record-logs all --take-screenshots failing 2>&1 | tee e2e/reports/test-output.log || true
        timeout-minutes: 15
        id: detox_tests

      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-test-report
          path: |
            apps/frontend_mobile/iayos_mobile/e2e/reports/
            apps/frontend_mobile/iayos_mobile/e2e/artifacts/
          retention-days: 14
          if-no-files-found: warn
